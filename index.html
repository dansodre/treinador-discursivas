<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treinador de Discursivas - EPPGG/SE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <!-- Bibliotecas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .prose-custom p { margin-bottom: 1em; }
        .prose-custom h3 { margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose-custom ul { list-style-position: inside; padding-left: 1em; }
        .prose-custom li { margin-bottom: 0.5em; }
        #analysisResult blockquote {
            border-left: 4px solid #e5e7eb; padding-left: 1rem;
            margin-left: 0; font-style: italic; color: #4b5563;
        }
        .mode-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .modal-overlay { transition: opacity 0.3s ease; }

        /* Estilo para o relatório de impressão */
        .printable-report {
            position: absolute; left: -9999px; width: 800px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; background-color: #fff;
        }
        .printable-report .header { background-color: #343a40; color: white; padding: 20px; text-align: center; }
        .printable-report .card { padding: 25px; border-bottom: 1px solid #dee2e6; }
        .printable-report h1, .printable-report h2, .printable-report h3 { color: #343a40; }
        .printable-report h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; }
        .printable-report blockquote { border-left: 5px solid #007bff; margin: 1em 0; padding: 1em; background-color: #f1f3f5; }
        .printable-report pre { background-color: #e9ecef; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; }
        .printable-report table { border-collapse: collapse; width: 100%; margin-top: 1em; }
        .printable-report th, .printable-report td { border: 1px solid #ced4da; padding: 12px; text-align: left; }
        .printable-report th { background-color: #e9ecef; font-weight: 600; }

        /* Estilos Flashcard */
        .flashcard-container { perspective: 1000px; }
        .flashcard {
            width: 100%; height: 250px; position: relative;
            transform-style: preserve-3d; transition: transform 0.6s;
        }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
            border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .flashcard-front { background-color: #f3f4f6; border: 1px solid #d1d5db; }
        .flashcard-back {
            background-color: #e0f2fe; color: #0c4a6e;
            transform: rotateY(180deg);
            border: 1px solid #bae6fd;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl relative">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Treinador de Discursivas</h1>
            <p class="text-md text-gray-600 mt-2">EPPGG - Governo do Estado de Sergipe</p>
        </header>

        <!-- Settings Button -->
        <div class="absolute top-0 right-0 p-4">
            <button id="settingsButton" class="text-gray-500 hover:text-gray-800 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>

        <main id="app" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg min-h-[500px] flex flex-col">

            <!-- Telas de Seleção -->
            <div id="modeSelection">
                <h2 class="text-2xl font-semibold mb-6 text-center text-gray-800">Escolha seu modo de treino</h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                    <button data-mode="focado" class="mode-card bg-blue-50 p-6 rounded-xl border border-blue-200"><h3 class="font-bold text-lg text-blue-800">Questão Focada</h3><p class="text-sm text-blue-700 mt-2">Treine um tópico específico.</p></button>
                    <button data-mode="interdisciplinar" class="mode-card bg-purple-50 p-6 rounded-xl border border-purple-200"><h3 class="font-bold text-lg text-purple-800">Questão Interdisciplinar</h3><p class="text-sm text-purple-700 mt-2">Combine matérias.</p></button>
                    <button data-mode="classico" class="mode-card bg-gray-50 p-6 rounded-xl border border-gray-200"><h3 class="font-bold text-lg text-gray-800">Questão por Nível</h3><p class="text-sm text-gray-700 mt-2">Pratique por dificuldade.</p></button>
                    <button data-mode="flashcards" class="mode-card bg-green-50 p-6 rounded-xl border border-green-200"><h3 class="font-bold text-lg text-green-800">Flashcards</h3><p class="text-sm text-green-700 mt-2">Memorize os conceitos.</p></button>
                </div>
            </div>

            <div id="subjectSelection" class="hidden">
                 <h2 class="text-xl font-semibold mb-4 text-center">Selecione a Matéria</h2>
                 <div id="subjectGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
                 <button class="back-button mt-6 bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button>
            </div>
            
            <div id="topicSelection" class="hidden flex-grow flex flex-col">
                <h2 id="topicSelectionHeader" class="text-xl font-semibold mb-4 text-center">Selecione o(s) Tópico(s)</h2>
                <div id="topicCheckboxes" class="space-y-3 custom-scrollbar overflow-y-auto max-h-[350px] p-2 border rounded-lg"></div>
                <div class="mt-4 flex gap-4">
                    <button id="generateFocusedQuestion" class="w-full bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 disabled:bg-blue-300" disabled>Gerar Questão</button>
                    <button class="back-button w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button>
                </div>
            </div>

            <div id="interdisciplinarySelection" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">Combine as Matérias</h2>
                <p class="text-center text-sm text-gray-500 mb-4">Selecione duas ou mais matérias para gerar uma questão.</p>
                <div id="interdisciplinaryCheckboxes" class="space-y-3"></div>
                <div class="mt-6 flex gap-4"><button id="generateInterdisciplinaryQuestion" class="w-full bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 disabled:bg-purple-300" disabled>Gerar Questão</button><button class="back-button w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button></div>
            </div>

            <div id="levelSelection" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">Selecione o Nível</h2>
                <div id="levelGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
                <button class="back-button mt-6 bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button>
            </div>
            
            <!-- Tela de Flashcards -->
            <div id="flashcardScreen" class="hidden flex-grow flex flex-col">
                <div class="mb-4 flex flex-col sm:flex-row gap-4 items-center">
                    <label for="flashcardSubjectSelect" class="font-semibold text-gray-700">Matéria:</label>
                    <select id="flashcardSubjectSelect" class="flex-grow p-2 border border-gray-300 rounded-lg"></select>
                </div>
                <div id="flashcardContainer" class="flashcard-container flex-grow flex items-center justify-center">
                    <div id="flashcard" class="flashcard">
                        <div id="flashcardFront" class="flashcard-face flashcard-front text-2xl font-bold"></div>
                        <div id="flashcardBack" class="flashcard-face flashcard-back text-lg"></div>
                    </div>
                </div>
                 <div class="mt-6 flex flex-col sm:flex-row gap-3">
                    <button id="flipCardButton" class="w-full sm:w-auto bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 flex-grow">Virar Card</button>
                    <button id="nextCardButton" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Próximo Conceito</button>
                    <button class="back-button w-full sm:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar ao Menu</button>
                </div>
            </div>

            <!-- Tela da Questão -->
            <div id="questionScreen" class="hidden">
                <div class="mb-6"><div class="flex justify-between items-center mb-2"><span id="questionTopic" class="text-xs font-semibold uppercase text-blue-600 bg-blue-100 px-3 py-1 rounded-full"></span><span id="questionLevel" class="text-xs font-semibold uppercase text-gray-500"></span></div><h3 class="text-lg font-semibold leading-relaxed" id="questionText"></h3></div>
                <div><label for="userAnswer" class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta (20 a 30 linhas):</label><textarea id="userAnswer" rows="12" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea><div class="flex justify-between items-center mt-1"><span id="lineCount" class="text-sm text-gray-500">0 linhas</span><span id="charCount" class="text-sm text-gray-500">0 caracteres</span></div></div>
                <div class="mt-6 flex flex-col sm:flex-row gap-3"><button id="submitAnswer" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex-grow">Analisar</button><button id="backToMain" class="w-full sm:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar ao Início</button></div>
            </div>
            
            <!-- Tela de Análise -->
            <div id="analysisScreen" class="hidden">
                <div id="loader" class="text-center py-10"><svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-4 text-lg font-semibold text-gray-700">Analisando sua resposta...</p></div>
                <div id="analysisResult" class="hidden prose-custom max-w-none"></div>
                <div id="analysisControls" class="hidden mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row gap-3"><button id="nextQuestion" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 flex-grow">Próxima Questão</button><button id="downloadReport" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Baixar Relatório (PDF)</button><button id="backToMainFromAnalysis" class="w-full sm:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar ao Início</button></div>
            </div>
        </main>
    </div>

    <!-- Div para gerar PDF -->
    <div id="reportContainer" class="printable-report"></div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 md:p-8">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">Configurações</h2><button id="closeModalButton" class="text-gray-500 hover:text-gray-800">&times;</button></div>
            <div class="space-y-4"><label for="apiKeyInput" class="block text-sm font-medium text-gray-700">Sua Chave da API do Gemini</label><input type="password" id="apiKeyInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Cole sua chave aqui"><p class="text-xs text-gray-500">Sua chave é salva apenas no seu navegador. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Obtenha sua chave aqui.</a></p></div>
            <div class="mt-6 flex flex-col sm:flex-row gap-3"><button id="saveApiKeyButton" class="w-full bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Salvar Chave</button><button id="clearApiKeyButton" class="w-full sm:w-auto bg-red-100 text-red-700 font-semibold py-2 px-6 rounded-lg hover:bg-red-200">Limpar Chave</button></div>
        </div>
    </div>


    <script>
        const { jsPDF } = window.jspdf;
        // --- BANCO DE DADOS DE CONTEÚDO DO EDITAL ---
        const subjectDetailsDB = {
            'Direito Administrativo': {
                name: 'Direito Administrativo',
                topics: ['Estado, governo e administração', 'Princípios da Adm. Pública', 'Poderes da administração', 'Organização administrativa', 'Ato administrativo', 'Licitação e Contratos (Leis 8.666, 10.520 e 14.133)', 'Controle da administração', 'Improbidade Administrativa', 'Lei Anticorrupção', 'Responsabilidade Civil do Estado'],
                questions: [
                    { level: 1, topic: 'Ato administrativo', text: 'Discorra sobre o conceito e os principais atributos do Ato Administrativo, explicando a importância de cada um para a atuação do Estado.' },
                    { level: 2, topic: 'Controle da administração', text: 'Diferencie o controle administrativo, judicial e legislativo da Administração Pública, exemplificando uma ferramenta de cada tipo de controle.' },
                    { level: 3, topic: 'Licitação e Contratos (Leis 8.666, 10.520 e 14.133)', text: 'Compare as modalidades de licitação previstas na Lei nº 8.666/1993 com as da nova Lei de Licitações e Contratos (Lei nº 14.133/2021), destacando a principal inovação trazida pelo novo diploma legal.' },
                    { level: 5, topic: 'Licitações Sustentáveis', subjects: ['Direito Administrativo', 'Políticas Públicas', 'AFO'], text: 'Discorra sobre o conceito de licitações sustentáveis à luz da Lei nº 14.133/2021. Relacione a sua aplicação com os objetivos de políticas públicas de desenvolvimento nacional sustentável e com os desafios do controle de custos no orçamento público.' },
                ],
                flashcards: [
                    { term: "Ato Administrativo", definition: "Manifestação unilateral de vontade da Administração Pública que, agindo nessa qualidade, tenha por fim imediato adquirir, resguardar, transferir, modificar, extinguir e declarar direitos, ou impor obrigações aos administrados ou a si própria." },
                    { term: "Princípio da Legalidade", definition: "A Administração Pública só pode fazer o que a lei permite. Diferente do particular, que pode fazer tudo o que a lei não proíbe." },
                    { term: "Poder de Polícia", definition: "Faculdade que dispõe a Administração Pública para condicionar e restringir o uso e gozo de bens, atividades e direitos individuais, em benefício da coletividade ou do próprio Estado." },
                ]
            },
            'Direito Constitucional': {
                name: 'Direito Constitucional',
                topics: ['Aplicabilidade das normas', 'Direitos e garantias fundamentais', 'Organização do Estado', 'Administração Pública na CF', 'Poder Executivo', 'Poder Legislativo', 'Poder Judiciário', 'Funções essenciais à justiça'],
                questions: [
                    { level: 1, topic: 'Aplicabilidade das normas', text: 'Explique o conceito de aplicabilidade das normas constitucionais, diferenciando normas de eficácia plena, contida e limitada, e apresente um exemplo para cada tipo.' },
                    { level: 3, topic: 'Organização do Estado', text: 'Analise o federalismo brasileiro, conforme a Constituição de 1988, explicando a repartição de competências entre União, Estados e Municípios e um desafio atual para a cooperação intergovernamental.' },
                    { level: 5, topic: 'Transparência vs. LGPD', subjects: ['Direito Constitucional', 'Direito Administrativo'], text: 'Analise a aparente colisão entre o princípio da publicidade e o direito à transparência (Lei de Acesso à Informação) e o direito fundamental à proteção de dados pessoais (LGPD). Como um gestor público deve ponderar esses direitos ao divulgar informações que contenham dados pessoais?' },
                ],
                flashcards: [
                    { term: "Norma de Eficácia Plena", definition: "Produz todos os seus efeitos desde a entrada em vigor da Constituição, independentemente de lei posterior que a regulamente." },
                    { term: "Controle de Constitucionalidade", definition: "Verificação da compatibilidade de uma lei ou ato normativo com a Constituição, visando a supremacia da Carta Magna." },
                    { term: "Remédios Constitucionais", definition: "Ações judiciais à disposição dos cidadãos para se protegerem de ilegalidades ou abuso de poder por parte do Estado (Ex: Habeas Corpus, Mandado de Segurança)." },
                ]
            },
            'AFO': {
                name: 'Admin. Financeira e Orçamentária',
                topics: ['Princípios orçamentários', 'Ciclo orçamentário', 'PPA, LDO e LOA', 'Receita Pública', 'Despesa Pública', 'Créditos adicionais', 'Restos a Pagar', 'Lei de Responsabilidade Fiscal (LRF)'],
                questions: [
                    { level: 1, topic: 'Princípios orçamentários', text: 'Cite e explique três princípios orçamentários previstos na legislação brasileira.' },
                    { level: 2, topic: 'Ciclo orçamentário', text: 'Explique o Ciclo Orçamentário no Brasil, descrevendo sucintamente as quatro principais etapas (elaboração, aprovação, execução e controle).' },
                    { level: 4, topic: 'Restos a Pagar', text: 'Explique o que são "Restos a Pagar" no contexto da execução orçamentária e da Lei de Responsabilidade Fiscal, diferenciando os processados dos não processados e as implicações de sua inscrição para a gestão fiscal.'},
                ],
                flashcards: [
                    { term: "PPA (Plano Plurianual)", definition: "Instrumento de planejamento de médio prazo (4 anos) que estabelece as diretrizes, objetivos e metas da administração pública para as despesas de capital e outras delas decorrentes." },
                    { term: "LDO (Lei de Diretrizes Orçamentárias)", definition: "Elo entre o PPA e a LOA. Define as metas e prioridades para o ano seguinte, orienta a elaboração da LOA e dispõe sobre alterações na legislação tributária." },
                    { term: "LOA (Lei Orçamentária Anual)", definition: "Lei que estima as receitas e fixa as despesas do governo para o período de um ano. Nenhuma despesa pública pode ser executada sem estar prevista na LOA." },
                    { term: "Regra de Ouro", definition: "Princípio constitucional (art. 167, III, CF) que proíbe a realização de operações de crédito (empréstimos) em montante superior às despesas de capital (investimentos)." },
                ]
            },
            'Políticas Públicas': {
                name: 'Teoria das Políticas Públicas',
                topics: ['Ciclo de políticas públicas', 'Planejamento e avaliação', 'Intermediação de interesses', 'Governança de Políticas Públicas'],
                questions: [
                    { level: 4, topic: 'Ciclo de políticas públicas', text: 'Descreva as fases do ciclo de políticas públicas (formulação, implementação e avaliação). Em seguida, explique a importância da fase de avaliação para o aprimoramento da gestão governamental e para a accountability.' },
                ],
                flashcards: [
                    { term: "Ciclo de Políticas Públicas", definition: "Modelo que organiza a vida de uma política pública em fases sequenciais: construção da agenda, formulação da política, tomada de decisão, implementação e avaliação." },
                    { term: "Avaliação Ex Ante", definition: "Avaliação realizada antes da implementação da política pública, com o objetivo de analisar sua viabilidade, custos e potenciais impactos." },
                    { term: "Governança", definition: "Refere-se aos processos e estruturas que envolvem a direção e o controle de uma organização ou Estado, incluindo a participação de múltiplos atores (Estado, mercado e sociedade civil)." },
                ]
            },
            'Ciência Política': {
                name: 'Ciência Política',
                topics: ['Conceitos fundamentais', 'Pensadores clássicos', 'Sistemas políticos e governança', 'Relações Institucionais', 'Política no Brasil'],
                questions: [
                    { level: 2, topic: 'Sistemas políticos e governança', text: 'Discorra sobre as formas de governo (República e Monarquia) e os sistemas de governo (Presidencialismo e Parlamentarismo), destacando as características do sistema adotado no Brasil.' },
                ],
                flashcards: [
                    { term: "Presidencialismo", definition: "Sistema de governo no qual o Chefe de Estado e o Chefe de Governo são a mesma pessoa (o Presidente), eleito por voto popular para um mandato fixo." },
                    { term: "Parlamentarismo", definition: "Sistema de governo com uma distinção clara entre Chefe de Estado (monarca ou presidente cerimonial) e Chefe de Governo (primeiro-ministro), que depende da confiança do parlamento para governar." },
                    { term: "Federalismo", definition: "Forma de organização do Estado em que o poder é dividido entre um governo central (União) e governos regionais (Estados), cada um com autonomia em suas esferas de competência." },
                ]
            },
            'Administração Pública': {
                name: 'Administração Pública',
                topics: ['Reformas administrativas', 'Modelos de gestão pública', 'Processos participativos', 'Governo eletrônico e transparência', 'Gestão por resultados', 'Planejamento (BSC, OKR)', 'Gestão de projetos e processos'],
                questions: [
                     { level: 1, topic: 'Modelos de gestão pública', text: 'Descreva o conceito de Administração Pública sob os sentidos formal e material. Em seguida, explique por que essa distinção é relevante para o estudo do Direito Administrativo.' },
                     { level: 2, topic: 'Reformas administrativas', text: 'Diferencie o modelo de administração pública burocrática do modelo gerencial (pós-burocrático), destacando os principais objetivos da reforma do aparelho do Estado no Brasil na década de 1990.' },
                ],
                flashcards: [
                    { term: "Administração Gerencial", definition: "Paradigma de gestão pública focado em resultados, eficiência e qualidade dos serviços, com maior autonomia para os gestores e uso de ferramentas do setor privado." },
                    { term: "Accountability", definition: "Conceito que abrange a obrigação de membros de um órgão administrativo ou de representantes de prestar contas de seus atos a instâncias controladoras e à sociedade." },
                    { term: "Governo Eletrônico (e-Gov)", definition: "Uso de tecnologias da informação e comunicação (TICs) para fornecer serviços públicos, melhorar a eficiência governamental e aumentar a participação cidadã." },
                ]
            },
            'Economia': {
                name: 'Economia',
                topics: ['Micro: Demanda e Oferta', 'Micro: Teoria do Consumidor', 'Micro: Mercados e Concorrência', 'Micro: Falhas de mercado', 'Macro: Contas Nacionais', 'Macro: Inflação e Juros', 'Macro: Política fiscal e monetária'],
                questions: [
                    { level: 2, topic: 'Macro: Inflação e Juros', text: 'Defina inflação e explique duas de suas principais causas. Em seguida, descreva um instrumento de política monetária que o Banco Central pode utilizar para contê-la.'},
                    { level: 3, topic: 'Micro: Falhas de mercado', text: 'Defina o conceito de "falhas de mercado" e discorra sobre duas delas (por exemplo, externalidades e bens públicos), explicando por que justificam a intervenção do Estado na economia.' },
                    { level: 5, topic: 'Política Fiscal e Desigualdade', subjects: ['Economia', 'Ciência Política', 'Administração Pública'], text: 'Discuta o papel do Estado na redução das desigualdades socioeconômicas no Brasil. Aborde, em sua resposta, ao menos dois instrumentos de política fiscal (lado da receita e/ou da despesa), um desafio político para sua implementação e um desafio de gestão para garantir sua efetividade.' },
                ],
                flashcards: [
                    { term: "Falhas de Mercado", definition: "Situações em que o mercado, por si só, não consegue alocar recursos de forma eficiente, justificando a intervenção do Estado. Ex: externalidades, bens públicos, assimetria de informação." },
                    { term: "Política Fiscal", definition: "Uso dos gastos do governo e da tributação para influenciar a economia. Pode ser expansionista (mais gastos/menos impostos) ou contracionista (menos gastos/mais impostos)." },
                    { term: "Política Monetária", definition: "Ações do Banco Central para controlar a oferta de moeda e as taxas de juros, visando principalmente a estabilidade dos preços (controle da inflação)." },
                ]
            },
            'Contabilidade Pública': {
                name: 'Contabilidade Pública',
                topics: ['Conceitos e campo de aplicação', 'Patrimônio Público', 'Demonstrações Contábeis (DCASP)', 'Plano de Contas (PCASP)', 'Regime orçamentário vs. patrimonial', 'Custos no Setor Público'],
                 questions: [
                    { level: 3, topic: 'Regime orçamentário vs. patrimonial', text: 'Diferencie o regime orçamentário do regime contábil (patrimonial) no setor público, explicando como cada um se aplica ao registro da receita e da despesa pública, conforme a Lei 4.320/64 e as novas normas contábeis (MCASP).' },
                ],
                flashcards: [
                    { term: "Regime de Competência", definition: "Regime contábil que registra os fatos (variações patrimoniais) na data em que ocorrem, independentemente de pagamento ou recebimento. É o regime patrimonial do setor público." },
                    { term: "Restos a Pagar", definition: "Despesas empenhadas mas não pagas dentro do exercício financeiro. Dividem-se em processados (liquidados) e não processados (não liquidados)." },
                    { term: "PCASP", definition: "Plano de Contas Aplicado ao Setor Público. Estrutura padronizada de contas contábeis que deve ser utilizada por todos os entes da Federação, visando a consolidação das contas nacionais." },
                ]
            }
        };

        const app = {
            ui: {
                modeSelection: document.getElementById('modeSelection'),
                subjectSelection: document.getElementById('subjectSelection'),
                topicSelection: document.getElementById('topicSelection'),
                interdisciplinarySelection: document.getElementById('interdisciplinarySelection'),
                levelSelection: document.getElementById('levelSelection'),
                flashcardScreen: document.getElementById('flashcardScreen'),
                questionScreen: document.getElementById('questionScreen'),
                analysisScreen: document.getElementById('analysisScreen'),
                loader: document.getElementById('loader'),
                analysisResult: document.getElementById('analysisResult'),
                analysisControls: document.getElementById('analysisControls'),
                questionTopic: document.getElementById('questionTopic'),
                questionLevel: document.getElementById('questionLevel'),
                questionText: document.getElementById('questionText'),
                userAnswer: document.getElementById('userAnswer'),
                lineCount: document.getElementById('lineCount'),
                charCount: document.getElementById('charCount'),
                subjectGrid: document.getElementById('subjectGrid'),
                topicCheckboxes: document.getElementById('topicCheckboxes'),
                topicSelectionHeader: document.getElementById('topicSelectionHeader'),
                generateFocusedQuestionBtn: document.getElementById('generateFocusedQuestion'),
                interdisciplinaryCheckboxes: document.getElementById('interdisciplinaryCheckboxes'),
                levelGrid: document.getElementById('levelGrid'),
                generateInterdisciplinaryBtn: document.getElementById('generateInterdisciplinaryQuestion'),
                settingsButton: document.getElementById('settingsButton'),
                settingsModal: document.getElementById('settingsModal'),
                closeModalButton: document.getElementById('closeModalButton'),
                apiKeyInput: document.getElementById('apiKeyInput'),
                saveApiKeyButton: document.getElementById('saveApiKeyButton'),
                clearApiKeyButton: document.getElementById('clearApiKeyButton'),
                // Flashcard UI
                flashcardSubjectSelect: document.getElementById('flashcardSubjectSelect'),
                flashcard: document.getElementById('flashcard'),
                flashcardFront: document.getElementById('flashcardFront'),
                flashcardBack: document.getElementById('flashcardBack'),
                flipCardButton: document.getElementById('flipCardButton'),
                nextCardButton: document.getElementById('nextCardButton'),
            },
            
            state: {
                currentMode: null, currentSubject: null, currentFilters: {},
                currentQuestion: null, lastQuestionIndex: -1, lastAnalysis: null,
                flashcardDeck: [], currentFlashcardIndex: 0,
            },

            init() {
                this.setupEventListeners();
                this.renderSelections();
                this.loadApiKey();
                this.showScreen('modeSelection');
            },
            
            setupEventListeners() {
                this.ui.modeSelection.addEventListener('click', e => this.handleModeSelection(e));
                document.querySelectorAll('.back-button').forEach(btn => btn.addEventListener('click', () => this.goBack()));
                this.ui.subjectGrid.addEventListener('click', e => this.handleSubjectSelection(e));
                this.ui.levelGrid.addEventListener('click', e => this.handleLevelSelection(e));
                
                this.ui.topicCheckboxes.addEventListener('change', () => this.updateFocusedButtonState());
                this.ui.generateFocusedQuestionBtn.addEventListener('click', () => this.startFocusedMode());

                this.ui.interdisciplinaryCheckboxes.addEventListener('change', () => this.updateInterdisciplinaryButtonState());
                this.ui.generateInterdisciplinaryBtn.addEventListener('click', () => this.startInterdisciplinaryMode());
                
                document.getElementById('submitAnswer').addEventListener('click', () => this.submitAnswer());
                document.getElementById('backToMain').addEventListener('click', () => this.showScreen('modeSelection'));
                document.getElementById('nextQuestion').addEventListener('click', () => this.loadQuestion());
                document.getElementById('backToMainFromAnalysis').addEventListener('click', () => this.showScreen('modeSelection'));
                document.getElementById('downloadReport').addEventListener('click', (e) => this.downloadReport(e.target));
                this.ui.userAnswer.addEventListener('input', () => this.updateCounts());

                this.ui.settingsButton.addEventListener('click', () => this.toggleModal(true));
                this.ui.closeModalButton.addEventListener('click', () => this.toggleModal(false));
                this.ui.settingsModal.addEventListener('click', (e) => { if (e.target === this.ui.settingsModal) this.toggleModal(false); });
                this.ui.saveApiKeyButton.addEventListener('click', () => this.saveApiKey());
                this.ui.clearApiKeyButton.addEventListener('click', () => this.clearApiKey());
                
                // Flashcard Listeners
                this.ui.flashcardSubjectSelect.addEventListener('change', (e) => this.loadFlashcardDeck(e.target.value));
                this.ui.flipCardButton.addEventListener('click', () => this.flipCard());
                this.ui.nextCardButton.addEventListener('click', () => this.nextCard());

            },
            
            renderSelections() {
                const subjectKeys = Object.keys(subjectDetailsDB);
                this.ui.subjectGrid.innerHTML = subjectKeys.map(key => `<button data-subject="${key}" class="w-full text-md font-semibold p-4 border rounded-lg transition hover:bg-blue-500 hover:text-white hover:border-blue-500">${subjectDetailsDB[key].name}</button>`).join('');
                this.ui.interdisciplinaryCheckboxes.innerHTML = subjectKeys.map(key => `<label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="subject" value="${key}" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"><span class="ml-3 text-gray-700">${subjectDetailsDB[key].name}</span></label>`).join('');
                this.ui.flashcardSubjectSelect.innerHTML = subjectKeys.map(key => `<option value="${key}">${subjectDetailsDB[key].name}</option>`).join('');
                const allLevels = [...new Set(Object.values(subjectDetailsDB).flatMap(s => s.questions.map(q => q.level)))];
                const levels = allLevels.filter(l => l <= 5).sort((a, b) => a - b);
                this.ui.levelGrid.innerHTML = levels.map(level => `<button data-level="${level}" class="w-full text-lg font-semibold p-4 border rounded-lg transition hover:bg-gray-500 hover:text-white hover:border-gray-500">Nível ${level}</button>`).join('');
            },

            handleModeSelection(e) {
                const button = e.target.closest('button');
                if (!button || !button.dataset.mode) return;
                this.state.currentMode = button.dataset.mode;
                if (this.state.currentMode === 'focado') this.showScreen('subjectSelection');
                else if (this.state.currentMode === 'interdisciplinar') this.showScreen('interdisciplinarySelection');
                else if (this.state.currentMode === 'classico') this.showScreen('levelSelection');
                else if (this.state.currentMode === 'flashcards') this.startFlashcardMode();
            },

            startFlashcardMode() {
                this.showScreen('flashcardScreen');
                this.loadFlashcardDeck(this.ui.flashcardSubjectSelect.value);
            },

            loadFlashcardDeck(subjectKey) {
                const deck = subjectDetailsDB[subjectKey]?.flashcards || [];
                // Shuffle deck
                this.state.flashcardDeck = deck
                    .map(value => ({ value, sort: Math.random() }))
                    .sort((a, b) => a.sort - b.sort)
                    .map(({ value }) => value);
                this.state.currentFlashcardIndex = 0;
                this.displayCurrentCard();
            },

            displayCurrentCard() {
                if(this.ui.flashcard.classList.contains('is-flipped')) {
                    this.ui.flashcard.classList.remove('is-flipped');
                }
                setTimeout(() => {
                    const card = this.state.flashcardDeck[this.state.currentFlashcardIndex];
                    if (card) {
                        this.ui.flashcardFront.textContent = card.term;
                        this.ui.flashcardBack.textContent = card.definition;
                    } else {
                        this.ui.flashcardFront.textContent = 'Fim dos cards!';
                        this.ui.flashcardBack.textContent = 'Selecione outra matéria para continuar.';
                    }
                }, 300); // Aguarda a animação de virar
            },

            flipCard() {
                this.ui.flashcard.classList.toggle('is-flipped');
            },

            nextCard() {
                this.state.currentFlashcardIndex = (this.state.currentFlashcardIndex + 1);
                if (this.state.currentFlashcardIndex >= this.state.flashcardDeck.length) {
                    this.state.currentFlashcardIndex = 0; // Volta para o início
                }
                this.displayCurrentCard();
            },

            // ... (restante do código das outras funções permanece igual)
            handleSubjectSelection(e){const t=e.target.closest("button");t&&t.dataset.subject&&(this.state.currentSubject=t.dataset.subject,this.renderTopics(this.state.currentSubject),this.showScreen("topicSelection"))},handleLevelSelection(e){const t=e.target.closest("button");t&&t.dataset.level&&(this.state.currentFilters={level:parseInt(t.dataset.level)},this.loadQuestion())},renderTopics(e){const t=subjectDetailsDB[e];this.ui.topicSelectionHeader.textContent=`Tópicos de ${t.name}`,this.ui.topicCheckboxes.innerHTML=t.topics.map(e=>`<label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">\n                        <input type="checkbox" name="topic" value="${e}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">\n                        <span class="ml-3 text-gray-700">${e}</span>\n                    </label>`).join(""),this.updateFocusedButtonState()},goBack(){"focado"===this.state.currentMode&&this.state.currentSubject?(this.state.currentSubject=null,this.showScreen("subjectSelection")):(this.state.currentMode=null,this.showScreen("modeSelection"))},startFocusedMode(){const e=Array.from(this.ui.topicCheckboxes.querySelectorAll("input:checked")).map(e=>e.value);this.state.currentFilters={subject:this.state.currentSubject,topics:e},this.loadQuestion()},updateFocusedButtonState(){this.ui.generateFocusedQuestionBtn.disabled=this.ui.topicCheckboxes.querySelectorAll("input:checked").length<1},startInterdisciplinaryMode(){const e=Array.from(this.ui.interdisciplinaryCheckboxes.querySelectorAll("input:checked")).map(e=>e.value);this.state.currentFilters={subjects:e,interdisciplinary:!0},this.loadQuestion()},updateInterdisciplinaryButtonState(){this.ui.generateInterdisciplinaryBtn.disabled=this.ui.interdisciplinaryCheckboxes.querySelectorAll("input:checked").length<2},getFilteredQuestions(){const{level:e,subject:t,topics:s,subjects:i,interdisciplinary:o}=this.state.currentFilters;return Object.entries(subjectDetailsDB).flatMap(([e,t])=>t.questions.map(s=>({...s,subjectKey:e,subjects:s.subjects||[e]}))).filter(n=>(!e||n.level===e)&&(!t||n.subjectKey===t)&&(!t||!s||0===s.length||s.includes(n.topic))&&void 0)},async loadQuestion(){let e=this.getFilteredQuestions();if(0===e.length){if(!localStorage.getItem("geminiApiKey")){alert("Para gerar questões inéditas, é necessário inserir sua chave da API do Gemini nas configurações."),this.toggleModal(!0);return}this.showScreen("loader");try{const t=await this.generateNewQuestion();this.state.currentQuestion={level:this.state.currentFilters.level||5,subjects:this.state.currentFilters.subjects||[this.state.currentSubject],topic:this.state.currentFilters.topics?this.state.currentFilters.topics.join(" + "):"Geral (Interdisciplinar)",text:t}}catch(e){alert("Não foi possível gerar uma nova questão. Tente outra combinação ou verifique sua chave de API."),this.showScreen("modeSelection");return}}else{let t;do{t=Math.floor(Math.random()*e.length)}while(e.length>1&&t===this.state.lastQuestionIndex);this.state.lastQuestionIndex=t,this.state.currentQuestion=e[t]}this.ui.questionTopic.textContent=this.state.currentQuestion.topic,this.ui.questionLevel.textContent=`Nível ${this.state.currentQuestion.level}`,this.ui.questionText.textContent=this.state.currentQuestion.text,this.ui.userAnswer.value="",this.updateCounts(),this.showScreen("questionScreen")},async generateNewQuestion(){const{topics:e,subject:t,subjects:s}=this.state.currentFilters;let i="Gere uma única questão discursiva inédita para o concurso de EPPGG de Sergipe. A questão deve ser complexa, exigir raciocínio e ser estritamente aderente ao conteúdo do edital. ";e&&t?i+=`Foque no(s) tópico(s) "${e.join(", ")}" da matéria "${subjectDetailsDB[t].name}".`:s&&(i+=`A questão deve ser interdisciplinar, conectando as matérias: ${s.map(e=>subjectDetailsDB[e].name).join(", ")}.`);const o=`Você é um elaborador de questões de concurso. Sua tarefa é criar uma questão discursiva. Responda APENAS com o texto da questão, sem nenhum texto adicional. ${i}`;return await this.callGeminiAPI(o)},updateCounts(){const e=this.ui.userAnswer.value,t=e.trim()?"":e.split("\n").length;this.ui.charCount.textContent=`${e.length} caracteres`,this.ui.lineCount.textContent=`${t} linha${1!==t?"s":""}`},showScreen(e){["modeSelection","subjectSelection","topicSelection","interdisciplinarySelection","levelSelection","questionScreen","analysisScreen","loader","flashcardScreen"].forEach(t=>this.ui[t]?.classList.add("hidden")),this.ui[e]&&this.ui[e].classList.remove("hidden"),"analysisScreen"!==e&&"loader"!==e||(this.ui.loader.classList.remove("hidden"),this.ui.analysisResult.classList.add("hidden"),this.ui.analysisControls.classList.add("hidden"))},async submitAnswer(){const e=this.ui.userAnswer.value.trim();if(e.length<50){alert("Por favor, elabore um pouco mais sua resposta.");return}if(!localStorage.getItem("geminiApiKey")){alert("Por favor, insira sua chave da API do Gemini nas configurações para usar a análise."),this.toggleModal(!0);return}this.showScreen("analysisScreen");try{const t=`Você é um examinador experiente de concursos públicos para o cargo de Especialista em Políticas Públicas e Gestão Governamental. Sua tarefa é analisar uma resposta discursiva de um candidato de forma crítica e construtiva. A sua resposta DEVE ser em Markdown e seguir ESTRITAMENTE a estrutura abaixo:
### Análise da Resposta
Faça uma análise geral da resposta do candidato.
### Atribuição de Nota (Simulada)
Apresente uma tabela em Markdown com a nota (máximo 40 pontos), dividida entre "Correção de Conteúdo" (20) e "Correção Formal" (20), com justificativas.
| Critério | Pontuação Máxima | Nota Atribuída | Justificativa |
| :--- | :--- | :--- | :--- |
| **A. Correção de Conteúdo** | **20** | ... | ... |
| **B. Correção Formal** | **20** | ... | ... |
| **NOTA FINAL** | **40** | **...** | |
### Ponderações e Pontos a Melhorar
Crie duas listas: **Pontos Fortes** e **Pontos a Melhorar**, com sugestões práticas.
### Versão Aprimorada da Resposta
Reescreva a resposta de forma ideal, como um gabarito nota máxima. Envolva o texto em um bloco de citação (blockquote).
---
**Questão Proposta:** "${this.state.currentQuestion.text}"
**Resposta do Candidato:** "${e}"`,s=await this.callGeminiAPI(t);this.displayAnalysis(s,e)}catch(t){console.error(t),this.displayAnalysis("# Erro na Análise\n\nOcorreu um problema ao contatar o examinador virtual. Verifique se sua chave da API do Gemini está correta nas configurações ou tente novamente.",e)}},async callGeminiAPI(e){const t=localStorage.getItem("geminiApiKey");if(!t)throw new Error("Chave da API não encontrada. Por favor, insira sua chave nas configurações.");const s=[{role:"user",parts:[{text:e}]}],i={contents:s},o=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${t}`,n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!n.ok){const e=await n.json();throw new Error(`Erro na API: ${e.error?.message||n.statusText}`)}const a=await n.json();if(a.candidates&&a.candidates[0].content&&a.candidates[0].content.parts[0])return a.candidates[0].content.parts[0].text;throw new Error("Resposta da API em formato inesperado.")},displayAnalysis(e,t){this.state.lastAnalysis={question:this.state.currentQuestion,userAnswer:t,analysisMarkdown:e};const s=new showdown.Converter({tables:!0,strikethrough:!0,literalMidWordUnderscores:!0});this.ui.analysisResult.innerHTML=s.makeHtml(e),this.ui.loader.classList.add("hidden"),this.ui.analysisResult.classList.remove("hidden"),this.ui.analysisControls.classList.remove("hidden")},async downloadReport(e){if(!this.state.lastAnalysis){alert("Nenhum relatório para baixar.");return}const t=e.textContent;e.textContent="Gerando...",e.disabled=!0;const{question:s,userAnswer:i,analysisMarkdown:o}=this.state.lastAnalysis,n=new showdown.Converter({tables:!0,strikethrough:!0}),a=n.makeHtml(o),l=document.getElementById("reportContainer");l.innerHTML=`
                    <div class="header"><h1>Relatório de Desempenho</h1></div>
                    <div class="card"><h2>Questão Proposta</h2><p><strong>Tópico:</strong> ${s.topic}</p><p>${s.text}</p></div>
                    <div class="card"><h2>Sua Resposta</h2><pre>${i.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre></div>
                    <div class="card"><h2>Análise do Examinador</h2>${a}</div>
                `;try{const s=await html2canvas(l,{scale:2,useCORS:!0}),i=s.toDataURL("image/png"),o=new jsPDF({orientation:"portrait",unit:"px",format:[s.width,s.height]});o.addImage(i,"PNG",0,0,s.width,s.height),o.save(`relatorio_discursiva_${(new Date).toISOString().slice(0,10)}.pdf`)}catch(s){console.error("Erro ao gerar o PDF:",s),alert("Ocorreu um erro ao gerar o PDF. Tente novamente.")}finally{e.textContent=t,e.disabled=!1}},toggleModal(e){e?this.ui.settingsModal.classList.remove("hidden"):this.ui.settingsModal.classList.add("hidden")},saveApiKey(){const e=this.ui.apiKeyInput.value.trim();e?(localStorage.setItem("geminiApiKey",e),alert("Chave da API salva com sucesso!"),this.toggleModal(!1)):alert("Por favor, insira uma chave válida.")},loadApiKey(){const e=localStorage.getItem("geminiApiKey");e&&(this.ui.apiKeyInput.value=e)},clearApiKey(){localStorage.removeItem("geminiApiKey"),this.ui.apiKeyInput.value="",alert("Chave da API removida.")}};

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
