<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treinador de Discursivas - SEFAZ/SE 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <!-- Bibliotecas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .prose-custom p { margin-bottom: 1em; }
        .prose-custom h3 { margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose-custom ul { list-style-position: inside; padding-left: 1em; }
        .prose-custom li { margin-bottom: 0.5em; }
        #analysisResult blockquote {
            border-left: 4px solid #e5e7eb; padding-left: 1rem;
            margin-left: 0; font-style: italic; color: #4b5563;
        }
        .mode-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .modal-overlay { transition: opacity 0.3s ease; }

        /* Estilo para o relatório de impressão */
        .printable-report {
            position: absolute; left: -9999px; width: 800px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; background-color: #fff;
        }
        .printable-report .header { background-color: #343a40; color: white; padding: 20px; text-align: center; }
        .printable-report .card { padding: 25px; border-bottom: 1px solid #dee2e6; }
        .printable-report h1, .printable-report h2, .printable-report h3 { color: #343a40; }
        .printable-report h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; }
        .printable-report blockquote { border-left: 5px solid #007bff; margin: 1em 0; padding: 1em; background-color: #f1f3f5; }
        .printable-report pre { background-color: #e9ecef; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; }
        .printable-report table { border-collapse: collapse; width: 100%; margin-top: 1em; }
        .printable-report th, .printable-report td { border: 1px solid #ced4da; padding: 12px; text-align: left; }
        .printable-report th { background-color: #e9ecef; font-weight: 600; }

        /* Estilos Flashcard */
        .flashcard-container { perspective: 1000px; }
        .flashcard {
            width: 100%; height: 250px; position: relative;
            transform-style: preserve-3d; transition: transform 0.6s;
        }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
            border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .flashcard-front { background-color: #f3f4f6; border: 1px solid #d1d5db; }
        .flashcard-back {
            background-color: #e0f2fe; color: #0c4a6e;
            transform: rotateY(180deg);
            border: 1px solid #bae6fd;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl relative">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Treinador de Discursivas</h1>
            <p class="text-md text-gray-600 mt-2">Auditor Fiscal de Tributos Estaduais - SEFAZ/SE 2025</p>
        </header>

        <!-- Settings Button -->
        <div class="absolute top-0 right-0 p-4">
            <button id="settingsButton" class="text-gray-500 hover:text-gray-800 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>

        <main id="app" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg min-h-[500px] flex flex-col">

            <!-- Telas de Seleção -->
            <div id="modeSelection">
                <h2 class="text-2xl font-semibold mb-6 text-center text-gray-800">Escolha seu modo de treino</h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                    <button data-mode="focado" class="mode-card bg-blue-50 p-6 rounded-xl border border-blue-200"><h3 class="font-bold text-lg text-blue-800">Questão Focada</h3><p class="text-sm text-blue-700 mt-2">Treine um tópico específico.</p></button>
                    <button data-mode="interdisciplinar" class="mode-card bg-purple-50 p-6 rounded-xl border border-purple-200"><h3 class="font-bold text-lg text-purple-800">Questão Interdisciplinar</h3><p class="text-sm text-purple-700 mt-2">Combine as matérias.</p></button>
                    <button data-mode="classico" class="mode-card bg-gray-50 p-6 rounded-xl border border-gray-200"><h3 class="font-bold text-lg text-gray-800">Questão por Nível</h3><p class="text-sm text-gray-700 mt-2">Pratique por dificuldade.</p></button>
                    <button data-mode="flashcards" class="mode-card bg-green-50 p-6 rounded-xl border border-green-200"><h3 class="font-bold text-lg text-green-800">Flashcards</h3><p class="text-sm text-green-700 mt-2">Memorize os conceitos.</p></button>
                </div>
            </div>

            <div id="subjectSelection" class="hidden">
                 <h2 class="text-xl font-semibold mb-4 text-center">Selecione a Matéria</h2>
                 <div id="subjectGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                 <button class="back-button mt-6 bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button>
            </div>
            
            <div id="topicSelection" class="hidden flex-grow flex flex-col">
                <h2 id="topicSelectionHeader" class="text-xl font-semibold mb-4 text-center">Selecione o(s) Tópico(s)</h2>
                <div id="topicCheckboxes" class="space-y-3 custom-scrollbar overflow-y-auto max-h-[350px] p-2 border rounded-lg"></div>
                <div class="mt-4 flex gap-4">
                    <button id="generateFocusedQuestion" class="w-full bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 disabled:bg-blue-300" disabled>Gerar Questão</button>
                    <button class="back-button w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button>
                </div>
            </div>

            <div id="interdisciplinarySelection" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">Combine as Matérias</h2>
                <p class="text-center text-sm text-gray-500 mb-4">Selecione as duas matérias para gerar uma questão.</p>
                <div id="interdisciplinaryCheckboxes" class="space-y-3"></div>
                <div class="mt-6 flex gap-4"><button id="generateInterdisciplinaryQuestion" class="w-full bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 disabled:bg-purple-300" disabled>Gerar Questão</button><button class="back-button w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button></div>
            </div>

            <div id="levelSelection" class="hidden flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-center">Selecione o Nível</h2>
                <div id="levelGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
                 <div id="subjectFilterForLevel" class="hidden mt-6 space-y-4">
                     <h3 class="text-lg font-semibold text-center text-gray-700">Filtre por Matéria (Opcional)</h3>
                     <select id="subjectFilterSelect" class="w-full p-2 border border-gray-300 rounded-lg"></select>
                     <div class="flex gap-4">
                         <button id="generateLevelQuestion" class="w-full bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-700">Gerar Questão</button>
                         <button class="back-to-levels-button w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button>
                     </div>
                 </div>
                <button class="back-button mt-6 bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 self-start">Voltar</button>
            </div>
            
            <!-- Tela de Flashcards -->
            <div id="flashcardScreen" class="hidden flex-grow flex flex-col">
                <h2 id="flashcardSubjectHeader" class="text-xl font-semibold mb-4 text-center"></h2>
                
                <!-- Controles de Modo de Estudo -->
                <div class="mb-2 flex flex-col sm:flex-row gap-2 items-center justify-center">
                    <fieldset class="flex flex-wrap gap-2">
                        <legend class="sr-only">Modo de Estudo</legend>
                        <div>
                            <input type="radio" name="flashcardMode" value="aleatorio_sem_repeticao" id="mode_aleatorio_sem_repeticao" class="peer hidden" checked>
                            <label for="mode_aleatorio_sem_repeticao" class="cursor-pointer rounded-lg border border-gray-300 px-3 py-2 text-sm peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-700">Aleatório (sem repetição)</label>
                        </div>
                        <div>
                            <input type="radio" name="flashcardMode" value="aleatorio_com_repeticao" id="mode_aleatorio_com_repeticao" class="peer hidden">
                            <label for="mode_aleatorio_com_repeticao" class="cursor-pointer rounded-lg border border-gray-300 px-3 py-2 text-sm peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-700">Aleatório (com repetição)</label>
                        </div>
                        <div>
                            <input type="radio" name="flashcardMode" value="sequencial" id="mode_sequencial" class="peer hidden">
                            <label for="mode_sequencial" class="cursor-pointer rounded-lg border border-gray-300 px-3 py-2 text-sm peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-700">Sequencial</label>
                        </div>
                    </fieldset>
                </div>
                
                <div id="flashcardCounter" class="text-center text-sm text-gray-500 mb-2"></div>

                <div id="flashcardContainer" class="flashcard-container flex-grow flex items-center justify-center">
                    <div id="flashcard" class="flashcard">
                        <div id="flashcardFront" class="flashcard-face flashcard-front text-xl font-bold"></div>
                        <div id="flashcardBack" class="flashcard-face flashcard-back text-sm text-left custom-scrollbar"></div>
                    </div>
                </div>
                 <div class="mt-6 flex flex-col sm:flex-row gap-3">
                    <button id="flipCardButton" class="w-full sm:w-auto bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 flex-grow">Virar Card</button>
                    <button id="nextCardButton" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Próximo Conceito</button>
                    <button class="back-button w-full sm:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button>
                </div>
            </div>

            <!-- Tela da Questão -->
            <div id="questionScreen" class="hidden">
                <div class="mb-6"><div class="flex justify-between items-center mb-2"><span id="questionTopic" class="text-xs font-semibold uppercase text-blue-600 bg-blue-100 px-3 py-1 rounded-full"></span><span id="questionLevel" class="text-xs font-semibold uppercase text-gray-500"></span></div><h3 class="text-lg font-semibold leading-relaxed" id="questionText"></h3></div>
                <div><label for="userAnswer" class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta (até 20 linhas):</label><textarea id="userAnswer" rows="12" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea><div class="flex justify-between items-center mt-1"><span id="lineCount" class="text-sm text-gray-500">0 linhas</span><span id="charCount" class="text-sm text-gray-500">0 caracteres</span></div></div>
                <div class="mt-6 flex flex-col sm:flex-row gap-3"><button id="submitAnswer" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex-grow">Analisar</button><button id="backToMain" class="w-full sm:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar ao Início</button></div>
            </div>
            
            <!-- Tela de Análise -->
            <div id="analysisScreen" class="hidden">
                <div id="loader" class="text-center py-10"><svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-4 text-lg font-semibold text-gray-700">Analisando sua resposta...</p></div>
                <div id="analysisResult" class="hidden prose-custom max-w-none"></div>
                <div id="analysisControls" class="hidden mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row gap-3"><button id="nextQuestion" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 flex-grow">Próxima Questão</button><button id="downloadReport" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Baixar Relatório (PDF)</button><button id="backToMainFromAnalysis" class="w-full sm:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar ao Início</button></div>
            </div>
        </main>
    </div>

    <!-- Div para gerar PDF -->
    <div id="reportContainer" class="printable-report"></div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 md:p-8">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">Configurações</h2><button id="closeModalButton" class="text-gray-500 hover:text-gray-800">&times;</button></div>
            <div class="space-y-4"><label for="apiKeyInput" class="block text-sm font-medium text-gray-700">Sua Chave da API do Gemini</label><input type="password" id="apiKeyInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Cole sua chave aqui"><p class="text-xs text-gray-500">Sua chave é salva apenas no seu navegador. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Obtenha sua chave aqui.</a></p></div>
            <div class="mt-6 flex flex-col sm:flex-row gap-3"><button id="saveApiKeyButton" class="w-full bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Salvar Chave</button><button id="clearApiKeyButton" class="w-full sm:w-auto bg-red-100 text-red-700 font-semibold py-2 px-6 rounded-lg hover:bg-red-200">Limpar Chave</button></div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        // --- BANCO DE DADOS DE CONTEÚDO DO EDITAL - SEFAZ/SE 2025 ---
        const subjectDetailsDB = {
            'Legislação Tributária Estadual': {
                name: 'Legislação Tributária Estadual',
                topics: [
                    'ICMS (Lei 3.796/96 e Dec. 21.400/02)',
                    'Processo Administrativo Fiscal (Lei 7.651/13)',
                    'PSDI (Lei 3.140/91)',
                    'FEEF (Lei 8.180/16)',
                    'IPVA (Lei 7.655/13)',
                    'ITCMD (Lei 7.724/13)',
                    'Taxa Estadual (TFSD - Lei 8.638/19)',
                    'Fundo de Combate à Pobreza (Lei 4.731/02)'
                ],
                questions: [
                    { level: 7, topic: 'ICMS (Lei 3.796/96 e Dec. 21.400/02)', subjects: ['Legislação Tributária Estadual'], text: 'Discorra sobre o instituto da substituição tributária "para frente" do ICMS, previsto na legislação de Sergipe. Aborde o conceito, a responsabilidade pelo recolhimento do imposto e a forma de cálculo da base de cálculo presumida.' },
                    { level: 8, topic: 'Processo Administrativo Fiscal (Lei 7.651/13)', subjects: ['Legislação Tributária Estadual'], text: 'Analise as fases do Processo Administrativo Fiscal em Sergipe, desde a lavratura do auto de infração até a decisão final em segunda instância. Destaque os principais direitos e garantias do contribuinte nesse processo.' },
                ],
                flashcards: [
                    { term: "O que é o fato gerador do ICMS, segundo a legislação de Sergipe?", definition: "<b>Resposta:</b> O fato gerador do ICMS é o momento em que a obrigação de pagar o imposto nasce. A Lei 3.796/96 define vários momentos, sendo os principais: a saída de mercadoria do estabelecimento do contribuinte; o fornecimento de alimentação e bebidas; a prestação de serviços de transporte interestadual e intermunicipal; e a prestação de serviços de comunicação." },
                    { term: "Quem é considerado contribuinte do ICMS em Sergipe?", definition: "<b>Resposta:</b> Contribuinte é qualquer pessoa, física ou jurídica, que realize, com habitualidade ou em volume que caracterize intuito comercial, operações de circulação de mercadoria ou prestações de serviços de transporte e de comunicação, ainda que as operações e as prestações se iniciem no exterior." },
                    { term: "O que é a base de cálculo do ICMS na venda de uma mercadoria?", definition: "<b>Resposta:</b> A base de cálculo é o valor da operação. Isso inclui não apenas o valor da mercadoria, mas também todas as importâncias recebidas pelo vendedor, como frete (se cobrado pelo vendedor), juros, seguros e outras despesas acessórias." },
                    { term: "Como funciona o princípio da não cumulatividade do ICMS?", definition: "<b>Resposta:</b> O princípio da não cumulatividade permite que o contribuinte abata, do imposto a pagar em suas operações de saída (vendas), o imposto que já foi pago nas operações de entrada (compras de insumos e mercadorias). Esse abatimento é feito através de um sistema de créditos e débitos.<br><br><b>Caso Prático:</b> Uma indústria compra R$ 10.000 em insumos com crédito de ICMS de R$ 1.200. Ela vende sua produção por R$ 30.000, gerando um débito de ICMS de R$ 5.400. Pela não cumulatividade, ela recolherá ao estado a diferença: R$ 5.400 (débito) - R$ 1.200 (crédito) = R$ 4.200." },
                    { term: "Qual o objetivo da Lei nº 7.651/2013 (Processo Administrativo Fiscal)?", definition: "<b>Resposta:</b> O objetivo é regular o processo que julga as disputas entre o Fisco estadual e os contribuintes sobre a exigência de tributos e penalidades, garantindo ao contribuinte o direito à ampla defesa e ao contraditório." },
                    { term: "Quais são as principais fases de um Processo Administrativo Fiscal (PAF)?", definition: "<b>Resposta:</b> As fases são: 1) Início (Auto de Infração); 2) Defesa (impugnação); 3) Julgamento em primeira instância; 4) Recurso para a segunda instância (Conselho de Contribuintes); 5) Decisão final.<br><br><b>Caso Prático:</b> Uma loja é autuada por não emitir notas. Ela apresenta sua defesa (impugnação). O processo é julgado em 1ª instância. Se a decisão for desfavorável, a loja pode recorrer ao Conselho de Contribuintes." },
                    { term: "O que é o Programa Sergipano de Desenvolvimento Industrial (PSDI)?", definition: "<b>Resposta:</b> O PSDI é um programa de incentivos fiscais do Governo de Sergipe que visa atrair e manter indústrias no estado, buscando promover o desenvolvimento econômico e social.<br><br><b>Caso Prático:</b> Uma nova fábrica de calçados se instala no interior de Sergipe e, ao ser enquadrada no PSDI, recebe um crédito presumido de 90% sobre o saldo devedor de ICMS, pagando apenas 10% do imposto devido." },
                    { term: "Qual a finalidade do Fundo Estadual de Equilíbrio Fiscal (FEEF)?", definition: "<b>Resposta:</b> O FEEF foi criado para fortalecer a arrecadação e manter o equilíbrio das finanças do estado, captando recursos de empresas que possuem incentivos fiscais.<br><br><b>Caso Prático:</b> A fábrica de calçados do exemplo anterior, que usufruiu de um incentivo de R$ 90.000, é obrigada a depositar 10% desse valor (R$ 9.000) no FEEF para manter seu benefício." },
                    { term: "Qual é o fato gerador e a base de cálculo do IPVA em Sergipe?", definition: "<b>Resposta:</b> O fato gerador é a propriedade de veículo automotor no dia 1º de janeiro. A base de cálculo é o valor venal do veículo, geralmente definido pela tabela FIPE.<br><br><b>Caso Prático:</b> Ana possui um carro com valor de R$ 50.000 na tabela FIPE. Com uma alíquota de 2,5%, o IPVA devido será de R$ 1.250 (R$ 50.000 x 2,5%)." },
                    { term: "O que tributa o ITCMD e como funcionam suas alíquotas em Sergipe?", definition: "<b>Resposta:</b> O ITCMD incide sobre a transmissão de quaisquer bens ou direitos por herança (causa mortis) ou por doação. As alíquotas são progressivas, de 3% a 8%, variando conforme o valor dos bens.<br><br><b>Caso Prático:</b> Carlos herda um imóvel de R$ 300.000. Para transferir o bem, ele precisa pagar o ITCMD. Aplicando a alíquota da faixa correspondente (ex: 3%), ele recolherá R$ 9.000 ao estado." }
                ]
            },
            'Auditoria Fiscal': {
                name: 'Auditoria Fiscal',
                topics: [
                    'Normas de Auditoria (NBC TA e PA)',
                    'Amostragem em Auditoria (NBC TA 530)',
                    'Testes de observância e substantivos',
                    'Evidências e procedimentos de auditoria',
                    'Fraudes na escrita contábil',
                    'Auditoria do Ativo Circulante (Caixa, Estoques)',
                    'Auditoria do Ativo Não Circulante',
                    'Auditoria do Passivo e PL',
                    'Auditoria de Contas de Resultado',
                    'Fraudes na escrita fiscal (EFD, NFe)',
                    'Auditoria no CIAP',
                    'Sigilo Bancário (LC 105/2001)'
                ],
                questions: [
                    { level: 9, topic: 'Fraudes na escrita fiscal (EFD, NFe)', subjects: ['Auditoria Fiscal'], text: 'Descreva os procedimentos de auditoria fiscal aplicáveis para identificar a omissão de receitas por meio da análise cruzada de dados da Escrituração Fiscal Digital (EFD) e das Notas Fiscais Eletrônicas (NFe) de entrada e saída. Cite ao menos três possíveis inconsistências a serem investigadas.' },
                    { level: 10, topic: 'Auditoria e Legislação', subjects: ['Auditoria Fiscal', 'Legislação Tributária Estadual'], text: 'Considerando as normas de auditoria fiscal (NBC TA) e a legislação do ICMS de Sergipe, descreva os procedimentos de auditoria que você aplicaria para identificar a falta de recolhimento do imposto decorrente de suprimentos de caixa não comprovados (passivo fictício) em uma empresa comercial. Relacione os achados da auditoria com as possíveis penalidades previstas na lei do Processo Administrativo Fiscal do estado.' }
                ],
                flashcards: [
                    { term: "O que são as NBC TA e as NBC PA?", definition: "<b>Resposta:</b> As NBC TA (Normas Técnicas de Auditoria) estabelecem os requisitos e orientações para a execução do trabalho de auditoria. As NBC PA (Normas Profissionais de Auditoria) tratam das responsabilidades e qualificações do auditor.<br><br><b>Caso Prático:</b> Um auditor fiscal, ao planejar seu trabalho, segue a NBC TA 300, definindo a estratégia, avaliando riscos e determinando a natureza e extensão dos procedimentos de auditoria." },
                    { term: "Para que serve a amostragem em auditoria (NBC TA 530)?", definition: "<b>Resposta:</b> Como é inviável verificar 100% das transações, o auditor seleciona uma amostra representativa para testar e obter evidência para concluir sobre toda a população.<br><br><b>Caso Prático:</b> Para verificar 5.000 notas de pagamento, um auditor usa amostragem estatística para analisar 200. Se não encontrar problemas significativos, pode concluir que o total das 5.000 está correto." },
                    { term: "O que são testes de observância (ou de controles)?", definition: "<b>Resposta:</b> São procedimentos para verificar se os controles internos definidos pela empresa estão sendo efetivamente cumpridos. O auditor foca no processo, não no valor final.<br><br><b>Caso Prático:</b> A política da empresa exige aprovação de um gerente para compras acima de R$ 10.000. O auditor seleciona 30 compras e verifica se todas têm a assinatura do gerente, testando se a regra foi seguida." },
                    { term: "O que são testes substantivos?", definition: "<b>Resposta:</b> São procedimentos para obter evidência direta sobre a exatidão dos valores registrados. O objetivo é detectar distorções materiais (erros ou fraudes) nos saldos e transações.<br><br><b>Caso Prático:</b> O auditor pega uma compra de R$ 50.000, confirma o valor com o fornecedor (circularização), verifica a entrada no estoque e o pagamento. Ele está validando a veracidade da transação." },
                    { term: "O que indica um saldo credor na conta Caixa?", definition: "<b>Resposta:</b> Um saldo credor (negativo) na conta Caixa é uma impossibilidade contábil e um forte indício de omissão de receitas (Caixa 2). Significa que saídas de dinheiro foram registradas sem a correspondente entrada declarada.<br><br><b>Caso Prático:</b> O caixa de uma loja termina o dia com -R$ 1.500 após um pagamento. Isso sugere que pelo menos R$ 1.500 em vendas sem nota fiscal entraram para cobrir o pagamento." },
                    { term: "Como a auditoria identifica aquisições não contabilizadas?", definition: "<b>Resposta:</b> Através do cruzamento de informações: comparando estoque físico com o contábil, analisando NFs de compra emitidas contra o CNPJ (que o Fisco possui) e verificando se foram escrituradas.<br><br><b>Caso Prático:</b> Um auditor encontra 50 TVs no estoque, mas os registros mostram a compra de apenas 30. Isso indica que 20 TVs foram adquiridas 'por fora', provavelmente com dinheiro de Caixa 2." },
                    { term: "O que é um passivo fictício?", definition: "<b>Resposta:</b> É o registro de uma dívida inexistente para simular uma despesa e justificar a sonegação de receitas. O dinheiro que 'pagaria' a dívida falsa vem de vendas não declaradas.<br><br><b>Caso Prático:</b> Uma empresa registra uma dívida de R$ 200.000 com um fornecedor 'Fantasma Ltda.'. O fiscal não encontra o contrato nem o CNPJ do fornecedor, concluindo que o passivo foi criado para ocultar R$ 200.000 de receita." },
                    { term: "Quais os 3 tipos de procedimentos de auditoria?", definition: "<b>Resposta:</b> 1) Avaliação de Riscos: Entender a entidade e seus controles para identificar riscos. 2) Testes de Controle: Avaliar a eficácia dos controles internos. 3) Procedimentos Substantivos: Detectar distorções relevantes nos valores.<br><br><b>Caso Prático:</b> Um auditor avalia o risco de fretes superfaturados, testa o controle (aprovação do gerente) e realiza um procedimento substantivo (confirma valores com a transportadora)." },
                    { term: "O que é a recomposição do fluxo de caixa?", definition: "<b>Resposta:</b> É uma técnica usada pelo Fisco para determinar a receita omitida. Compara-se o total de saídas de caixa com as entradas comprovadas. Se as saídas forem maiores, a diferença é considerada receita sonegada.<br><br><b>Caso Prático:</b> Uma empresa teve saídas de R$ 350.000, mas declarou apenas R$ 200.000 de entradas. O Fisco presume que a diferença de R$ 150.000 é receita de vendas 'por fora' e autua a empresa." },
                    { term: "O que é baixa fictícia de títulos não recebidos?", definition: "<b>Resposta:</b> É registrar uma conta a receber como 'Perda', quando na verdade o cliente pagou 'por fora'. O objetivo é que o dinheiro entre no caixa sem ser tributado como receita.<br><br><b>Caso Prático:</b> A empresa 'Alfa' dá baixa de R$ 20.000 como prejuízo. O auditor, ao contatar o cliente, descobre que ele pagou a dívida em dinheiro, com recibo. A fraude é descoberta e a receita omitida é tributada." },
                    { term: "Qual o objetivo de cotejar recebíveis com receitas?", definition: "<b>Resposta:</b> Garantir que toda venda a prazo registrada na DRE gerou um correspondente direito de recebimento no Balanço Patrimonial. Inconsistências podem indicar receitas fictícias.<br><br><b>Caso Prático:</b> Uma empresa registra R$ 5 milhões em vendas, mas o 'Contas a Receber' só aumenta R$ 1 milhão. A investigação pode revelar que a empresa emitiu notas frias para atingir metas." },
                    { term: "Qual o desafio na auditoria de ativos intangíveis?", definition: "<b>Resposta:</b> A subjetividade na avaliação do valor e da vida útil do ativo (ex: marca, software), abrindo margem para superavaliação e amortização indevida para reduzir lucros.<br><br><b>Caso Prático:</b> Uma empresa avalia um software de R$ 100 mil por R$ 1 milhão, gerando uma despesa de amortização muito maior. O fiscal pode contestar a avaliação e glosar o excesso de despesa." },
                    { term: "O que é passivo oculto (omissão de passivo)?", definition: "<b>Resposta:</b> É a prática de não registrar uma dívida real para apresentar uma situação financeira melhor do que a real, seja para enganar investidores ou obter empréstimos.<br><br><b>Caso Prático:</b> Para obter um empréstimo, uma empresa não registra uma dívida de R$ 500.000 com um fornecedor. O fiscal descobre a omissão ao cruzar as notas fiscais de entrada emitidas contra o CNPJ da empresa." },
                    { term: "Qual a implicação fiscal de um aumento de capital sem comprovação?", definition: "<b>Resposta:</b> Se o sócio não comprova a origem dos recursos para aumentar o capital da empresa, o Fisco pode presumir que o valor é, na verdade, receita da própria empresa que foi omitida, e então tributá-la.<br><br><b>Caso Prático:</b> Um sócio integraliza R$ 200.000 em dinheiro, mas sua declaração de IR é incompatível com tal valor. A fiscalização conclui que são vendas da empresa sem nota fiscal e autua a pessoa jurídica." },
                    { term: "O que é o CIAP e como é auditado na EFD?", definition: "<b>Resposta:</b> O CIAP (Controle de Crédito de ICMS do Ativo Permanente) controla o crédito de ICMS na aquisição de ativo imobilizado, apropriado em 48 parcelas. Na EFD, o fiscal verifica se o crédito mensal está correto (1/48), se o bem dá direito a crédito e se há estorno na venda antecipada." },
                    { term: "O que é o Bloco K da EFD e qual sua importância?", definition: "<b>Resposta:</b> É o Livro de Controle da Produção e do Estoque digital. Ele detalha o processo produtivo e é uma ferramenta poderosa para a fiscalização cruzar a quantidade de insumos comprados com a de produtos vendidos, identificando produção e venda não declaradas.<br><br><b>Caso Prático:</b> Uma fábrica comprou insumos para 1 milhão de garrafas, mas declarou a produção de apenas 800 mil. O fiscal pode autuar pela omissão de receita das 200 mil unidades restantes." }
                ]
            }
        };

        const app = {
            ui: {
                modeSelection: document.getElementById('modeSelection'),
                subjectSelection: document.getElementById('subjectSelection'),
                topicSelection: document.getElementById('topicSelection'),
                interdisciplinarySelection: document.getElementById('interdisciplinarySelection'),
                levelSelection: document.getElementById('levelSelection'),
                flashcardScreen: document.getElementById('flashcardScreen'),
                questionScreen: document.getElementById('questionScreen'),
                analysisScreen: document.getElementById('analysisScreen'),
                loader: document.getElementById('loader'),
                analysisResult: document.getElementById('analysisResult'),
                analysisControls: document.getElementById('analysisControls'),
                questionTopic: document.getElementById('questionTopic'),
                questionLevel: document.getElementById('questionLevel'),
                questionText: document.getElementById('questionText'),
                userAnswer: document.getElementById('userAnswer'),
                lineCount: document.getElementById('lineCount'),
                charCount: document.getElementById('charCount'),
                subjectGrid: document.getElementById('subjectGrid'),
                topicCheckboxes: document.getElementById('topicCheckboxes'),
                topicSelectionHeader: document.getElementById('topicSelectionHeader'),
                generateFocusedQuestionBtn: document.getElementById('generateFocusedQuestion'),
                interdisciplinaryCheckboxes: document.getElementById('interdisciplinaryCheckboxes'),
                levelGrid: document.getElementById('levelGrid'),
                generateInterdisciplinaryBtn: document.getElementById('generateInterdisciplinaryQuestion'),
                subjectFilterForLevel: document.getElementById('subjectFilterForLevel'),
                subjectFilterSelect: document.getElementById('subjectFilterSelect'),
                generateLevelQuestionBtn: document.getElementById('generateLevelQuestion'),
                settingsButton: document.getElementById('settingsButton'),
                settingsModal: document.getElementById('settingsModal'),
                closeModalButton: document.getElementById('closeModalButton'),
                apiKeyInput: document.getElementById('apiKeyInput'),
                saveApiKeyButton: document.getElementById('saveApiKeyButton'),
                clearApiKeyButton: document.getElementById('clearApiKeyButton'),
                // Flashcard UI
                flashcardSubjectHeader: document.getElementById('flashcardSubjectHeader'),
                flashcardCounter: document.getElementById('flashcardCounter'),
                flashcard: document.getElementById('flashcard'),
                flashcardFront: document.getElementById('flashcardFront'),
                flashcardBack: document.getElementById('flashcardBack'),
                flipCardButton: document.getElementById('flipCardButton'),
                nextCardButton: document.getElementById('nextCardButton'),
            },
            
            state: {
                currentMode: null, currentSubject: null, currentFilters: {},
                currentQuestion: null, lastQuestionIndex: -1, lastAnalysis: null,
                flashcardDeck: [], currentFlashcardIndex: 0,
            },

            init() {
                this.setupEventListeners();
                this.renderSelections();
                this.loadApiKey();
                this.showScreen('modeSelection');
            },
            
            setupEventListeners() {
                this.ui.modeSelection.addEventListener('click', e => this.handleModeSelection(e));
                document.querySelectorAll('.back-button').forEach(btn => btn.addEventListener('click', () => this.goBack()));
                this.ui.subjectGrid.addEventListener('click', e => this.handleSubjectSelection(e));
                this.ui.levelGrid.addEventListener('click', e => this.handleLevelSelection(e));
                
                this.ui.topicCheckboxes.addEventListener('change', () => this.updateFocusedButtonState());
                this.ui.generateFocusedQuestionBtn.addEventListener('click', () => this.startFocusedMode());

                this.ui.interdisciplinaryCheckboxes.addEventListener('change', () => this.updateInterdisciplinaryButtonState());
                this.ui.generateInterdisciplinaryBtn.addEventListener('click', () => this.startInterdisciplinaryMode());
                
                this.ui.generateLevelQuestionBtn.addEventListener('click', () => this.startClassicMode());
                document.querySelector('.back-to-levels-button').addEventListener('click', () => this.goBackToLevelGrid());

                document.getElementById('submitAnswer').addEventListener('click', () => this.submitAnswer());
                document.getElementById('backToMain').addEventListener('click', () => this.showScreen('modeSelection'));
                document.getElementById('nextQuestion').addEventListener('click', () => this.loadQuestion());
                document.getElementById('backToMainFromAnalysis').addEventListener('click', () => this.showScreen('modeSelection'));
                document.getElementById('downloadReport').addEventListener('click', (e) => this.downloadReport(e.target));
                this.ui.userAnswer.addEventListener('input', () => this.updateCounts());
                
                // Settings Listeners
                this.ui.settingsButton.addEventListener('click', () => this.toggleModal(true));
                this.ui.closeModalButton.addEventListener('click', () => this.toggleModal(false));
                this.ui.settingsModal.addEventListener('click', (e) => { if (e.target === this.ui.settingsModal) this.toggleModal(false); });
                this.ui.saveApiKeyButton.addEventListener('click', () => this.saveApiKey());
                this.ui.clearApiKeyButton.addEventListener('click', () => this.clearApiKey());

                // Flashcard Listeners
                document.querySelectorAll('input[name="flashcardMode"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        if (this.state.currentSubject) {
                            this.loadFlashcardDeck(this.state.currentSubject);
                        }
                    });
                });
                this.ui.flipCardButton.addEventListener('click', () => this.flipCard());
                this.ui.nextCardButton.addEventListener('click', () => this.nextCard());

            },
            
            renderSelections() {
                const subjectKeys = Object.keys(subjectDetailsDB);
                this.ui.subjectGrid.innerHTML = subjectKeys.map(key => `<button data-subject="${key}" class="w-full text-md font-semibold p-4 border rounded-lg transition hover:bg-blue-500 hover:text-white hover:border-blue-500">${subjectDetailsDB[key].name}</button>`).join('');
                this.ui.interdisciplinaryCheckboxes.innerHTML = subjectKeys.map(key => `<label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="subject" value="${key}" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"><span class="ml-3 text-gray-700">${subjectDetailsDB[key].name}</span></label>`).join('');
                
                let subjectOptions = `<option value="all">Todas as Matérias</option>`;
                subjectOptions += subjectKeys.map(key => `<option value="${key}">${subjectDetailsDB[key].name}</option>`).join('');
                this.ui.subjectFilterSelect.innerHTML = subjectOptions;

                const levels = Array.from({ length: 10 }, (_, i) => i + 1);
                this.ui.levelGrid.innerHTML = levels.map(level => `<button data-level="${level}" class="w-full text-lg font-semibold p-4 border rounded-lg transition hover:bg-gray-500 hover:text-white hover:border-gray-500">Nível ${level}</button>`).join('');
            },

            handleModeSelection(e) {
                const button = e.target.closest('button');
                if (!button || !button.dataset.mode) return;
                this.state.currentMode = button.dataset.mode;
                if (this.state.currentMode === 'focado' || this.state.currentMode === 'flashcards') {
                    this.showScreen('subjectSelection');
                } else if (this.state.currentMode === 'interdisciplinar') {
                    this.showScreen('interdisciplinarySelection');
                } else if (this.state.currentMode === 'classico') {
                    this.showScreen('levelSelection');
                }
            },

            handleSubjectSelection(e) {
                const button = e.target.closest("button");
                if (button && button.dataset.subject) {
                    this.state.currentSubject = button.dataset.subject;
                    if (this.state.currentMode === 'focado') {
                        this.renderTopics(this.state.currentSubject);
                        this.showScreen("topicSelection");
                    } else if (this.state.currentMode === 'flashcards') {
                        this.startFlashcardMode(this.state.currentSubject);
                    }
                }
            },

            startFlashcardMode(subjectKey) {
                this.ui.flashcardSubjectHeader.textContent = `Flashcards de ${subjectDetailsDB[subjectKey].name}`;
                this.showScreen('flashcardScreen');
                this.loadFlashcardDeck(subjectKey);
            },

            loadFlashcardDeck(subjectKey) {
                const studyMode = document.querySelector('input[name="flashcardMode"]:checked').value;
                const originalDeck = subjectDetailsDB[subjectKey]?.flashcards || [];

                if (studyMode === 'aleatorio_sem_repeticao') {
                    this.state.flashcardDeck = originalDeck
                        .map(value => ({ value, sort: Math.random() }))
                        .sort((a, b) => a.sort - b.sort)
                        .map(({ value }) => value);
                } else if (studyMode === 'sequencial') {
                    this.state.flashcardDeck = [...originalDeck]; 
                } else { // aleatorio_com_repeticao
                    this.state.flashcardDeck = [...originalDeck];
                }

                this.state.currentFlashcardIndex = 0;
                this.displayCurrentCard();
            },

            displayCurrentCard() {
                const studyMode = document.querySelector('input[name="flashcardMode"]:checked').value;

                if (studyMode === 'aleatorio_com_repeticao') {
                    this.ui.flashcardCounter.classList.add('hidden');
                } else {
                    this.ui.flashcardCounter.classList.remove('hidden');
                    if (this.state.flashcardDeck.length > 0) {
                        this.ui.flashcardCounter.textContent = `Card ${this.state.currentFlashcardIndex + 1} de ${this.state.flashcardDeck.length}`;
                    } else {
                        this.ui.flashcardCounter.textContent = '';
                    }
                }

                if(this.ui.flashcard.classList.contains('is-flipped')) {
                    this.ui.flashcard.classList.remove('is-flipped');
                }
                setTimeout(() => {
                    const card = this.state.flashcardDeck[this.state.currentFlashcardIndex];
                    if (card) {
                        this.ui.flashcardFront.textContent = card.term;
                        this.ui.flashcardBack.innerHTML = card.definition;
                    } else {
                        this.ui.flashcardFront.textContent = 'Sem cards!';
                        this.ui.flashcardBack.innerHTML = 'Não há conceitos para esta matéria no momento.';
                    }
                }, 300); 
            },

            flipCard() { this.ui.flashcard.classList.toggle('is-flipped'); },

            nextCard() {
                const studyMode = document.querySelector('input[name="flashcardMode"]:checked').value;

                if (studyMode === 'aleatorio_com_repeticao') {
                    if (this.state.flashcardDeck.length > 0) {
                        const randomIndex = Math.floor(Math.random() * this.state.flashcardDeck.length);
                        this.state.currentFlashcardIndex = randomIndex;
                        this.displayCurrentCard();
                    }
                    return;
                }

                this.state.currentFlashcardIndex++;
                if (this.state.currentFlashcardIndex >= this.state.flashcardDeck.length) {
                    if (this.ui.flashcard.classList.contains('is-flipped')) {
                        this.ui.flashcard.classList.remove('is-flipped');
                    }
                     setTimeout(() => {
                        this.ui.flashcardFront.textContent = 'Fim do Ciclo!';
                        this.ui.flashcardBack.textContent = 'Reiniciando o baralho...';
                        setTimeout(() => this.loadFlashcardDeck(this.state.currentSubject), 1500);
                    }, 300);
                } else {
                    this.displayCurrentCard();
                }
            },
            
            goBack() {
                if ((this.state.currentMode === 'focado' || this.state.currentMode === 'flashcards') && this.state.currentSubject) {
                    this.state.currentSubject = null;
                    this.showScreen("subjectSelection");
                } else {
                    this.state.currentMode = null;
                    this.showScreen("modeSelection");
                }
            },
            
            handleLevelSelection(e) {
                const button = e.target.closest('button');
                if (!button || !button.dataset.level) return;
                this.state.currentFilters = { level: parseInt(button.dataset.level) };
                this.ui.levelGrid.classList.add('hidden');
                this.ui.levelSelection.querySelector('.back-button').classList.add('hidden');
                this.ui.subjectFilterForLevel.classList.remove('hidden');
            },

            goBackToLevelGrid() {
                 this.ui.subjectFilterForLevel.classList.add('hidden');
                 this.ui.levelGrid.classList.remove('hidden');
                 this.ui.levelSelection.querySelector('.back-button').classList.remove('hidden');
                 this.state.currentFilters = {};
            },

            renderTopics(e){const t=subjectDetailsDB[e];this.ui.topicSelectionHeader.textContent=`Tópicos de ${t.name}`,this.ui.topicCheckboxes.innerHTML=t.topics.map(e=>`<label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">\n                         <input type="checkbox" name="topic" value="${e}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">\n                         <span class="ml-3 text-gray-700">${e}</span>\n                     </label>`).join(""),this.updateFocusedButtonState()},startFocusedMode(){const e=Array.from(this.ui.topicCheckboxes.querySelectorAll("input:checked")).map(e=>e.value);this.state.currentFilters={subject:this.state.currentSubject,topics:e},this.loadQuestion()},
            
            startClassicMode() {
                const subject = this.ui.subjectFilterSelect.value;
                if (subject && subject !== 'all') {
                    this.state.currentFilters.subject = subject;
                } else {
                    delete this.state.currentFilters.subject;
                }
                this.loadQuestion();
            },

            updateFocusedButtonState(){this.ui.generateFocusedQuestionBtn.disabled=this.ui.topicCheckboxes.querySelectorAll("input:checked").length<1},startInterdisciplinaryMode(){const e=Array.from(this.ui.interdisciplinaryCheckboxes.querySelectorAll("input:checked")).map(e=>e.value);this.state.currentFilters={subjects:e,interdisciplinary:!0},this.loadQuestion()},updateInterdisciplinaryButtonState(){this.ui.generateInterdisciplinaryBtn.disabled=this.ui.interdisciplinaryCheckboxes.querySelectorAll("input:checked").length<2},
            
            getFilteredQuestions() {
                const { level, subject, subjects, topics, interdisciplinary } = this.state.currentFilters;
                let allQuestions = Object.values(subjectDetailsDB).flatMap(s => s.questions);

                if (interdisciplinary) {
                    return allQuestions.filter(q => 
                        subjects && subjects.length > 1 && subjects.every(sub => q.subjects.includes(sub))
                    );
                }

                return allQuestions.filter(q => {
                    const levelMatch = !level || q.level === level;
                    const subjectMatch = !subject || q.subjects.includes(subject);
                    const topicMatch = !topics || !topics.length || topics.some(t => q.topic.includes(t));
                    return levelMatch && subjectMatch && topicMatch && q.subjects.length <= 1;
                });
            },
            
            async loadQuestion() {
                const displayQuestion = () => {
                    if (!this.state.currentQuestion) return;
                    this.ui.questionTopic.textContent = this.state.currentQuestion.topic;
                    this.ui.questionLevel.textContent = `Nível ${this.state.currentQuestion.level}`;
                    this.ui.questionText.textContent = this.state.currentQuestion.text;
                    this.ui.userAnswer.value = "";
                    this.updateCounts();
                    this.showScreen('questionScreen');
                };

                let filteredQuestions = this.getFilteredQuestions();
                
                if (filteredQuestions.length > 0) {
                    let newIndex;
                    do {
                        newIndex = Math.floor(Math.random() * filteredQuestions.length);
                    } while (filteredQuestions.length > 1 && newIndex === this.state.lastQuestionIndex);
                    this.state.lastQuestionIndex = newIndex;
                    this.state.currentQuestion = filteredQuestions[newIndex];
                    displayQuestion();
                } else {
                    if (!localStorage.getItem("geminiApiKey")) {
                        alert("Para gerar questões inéditas, é necessário inserir sua chave da API do Gemini nas configurações.");
                        this.toggleModal(true);
                        return;
                    }
                    this.showScreen("loader"); 
                    try {
                        const newQuestionText = await this.generateNewQuestion();
                        this.state.currentQuestion = {
                            level: this.state.currentFilters.level || 8,
                            subjects: this.state.currentFilters.subjects || [this.state.currentSubject],
                            topic: this.state.currentFilters.topics ? this.state.currentFilters.topics.join(' + ') : 'Geral (Interdisciplinar)',
                            text: newQuestionText
                        };
                        displayQuestion();
                    } catch (error) {
                        console.error("Erro ao gerar questão:", error);
                        alert(`Não foi possível gerar uma nova questão. Detalhes: ${error.message}`);
                        this.goBack();
                    }
                }
            },

            async generateNewQuestion() {
                const { topics, subject, subjects, level } = this.state.currentFilters;
                let context = `Gere uma única questão discursiva inédita para o concurso de Auditor Fiscal da SEFAZ/SE, com complexidade de nível ${level || 'avançado'}. A questão deve ser complexa, exigir raciocínio e ser estritamente aderente ao conteúdo do edital. `;
                if (topics && subject) {
                    context += `Foque no(s) tópico(s) "${topics.join(', ')}" da matéria "${subjectDetailsDB[subject].name}".`;
                } else if (subjects) {
                    context += `A questão deve ser interdisciplinar, conectando as matérias: ${subjects.map(s => subjectDetailsDB[s].name).join(' e ')}.`;
                }
                const prompt = `Você é um elaborador de questões de concurso da banca Cebraspe. Sua tarefa é criar uma questão discursiva. Responda APENAS com o texto da questão, sem nenhum texto adicional. ${context}`;
                return await this.callGeminiAPI(prompt);
            },

            updateCounts(){const e=this.ui.userAnswer.value,t=e.trim()?e.split("\n").length:0;this.ui.charCount.textContent=`${e.length} caracteres`,this.ui.lineCount.textContent=`${t} linha${1!==t?"s":""}`},showScreen(e){["modeSelection","subjectSelection","topicSelection","interdisciplinarySelection","levelSelection","questionScreen","analysisScreen","loader","flashcardScreen"].forEach(t=>this.ui[t]?.classList.add("hidden")),this.ui[e]&&this.ui[e].classList.remove("hidden"),"analysisScreen"!==e&&"loader"!==e||(this.ui.loader.classList.remove("hidden"),this.ui.analysisResult.classList.add("hidden"),this.ui.analysisControls.classList.add("hidden"))},
            
            async submitAnswer() {
                const userAnswer = this.ui.userAnswer.value.trim();
                if (userAnswer.length < 50) {
                    alert("Por favor, elabore um pouco mais sua resposta.");
                    return;
                }
                 if (!localStorage.getItem("geminiApiKey")) {
                    alert("Por favor, insira sua chave da API do Gemini nas configurações para usar a análise.");
                    this.toggleModal(true);
                    return;
                }
                this.showScreen("analysisScreen");
                try {
                    const prompt = `Você é um examinador experiente da banca Cebraspe, corrigindo uma prova para o cargo de Auditor Fiscal de Tributos Estaduais da SEFAZ/SE. Sua tarefa é analisar uma resposta discursiva de um candidato de forma crítica e construtiva. A sua resposta DEVE ser em Markdown e seguir ESTRITAMENTE a estrutura abaixo:
### Análise da Resposta
Faça uma análise geral da resposta do candidato, abordando o conhecimento técnico demonstrado.
### Atribuição de Nota (Simulada)
Apresente uma tabela em Markdown com a nota (máximo 40 pontos), dividida entre "Domínio do Conteúdo" (30) e "Domínio da Modalidade Escrita" (10), com justificativas claras e objetivas, conforme o edital.
| Critério | Pontuação Máxima | Nota Atribuída | Justificativa |
| :--- | :--- | :--- | :--- |
| **A. Domínio do Conteúdo** | **30** | ... | ... |
| **B. Domínio da Modalidade Escrita** | **10** | ... | ... |
| **NOTA FINAL** | **40** | **...** | |
### Ponderações e Pontos a Melhorar
Crie duas listas: **Pontos Fortes** e **Pontos a Melhorar**, com sugestões práticas e específicas para o concurso.
### Versão Aprimorada da Resposta
Reescreva a resposta de forma ideal, como um gabarito nota máxima, com linguagem técnica e precisa. Envolva o texto em um bloco de citação (blockquote).
---
**Questão Proposta:** "${this.state.currentQuestion.text}"
**Resposta do Candidato:** "${userAnswer}"`;
                    const analysis = await this.callGeminiAPI(prompt);
                    this.displayAnalysis(analysis, userAnswer);
                } catch (error) {
                    console.error(error);
                    this.displayAnalysis(`# Erro na Análise\n\nOcorreu um problema ao contatar o examinador virtual. Detalhes: ${error.message}`, userAnswer);
                }
            },

            async callGeminiAPI(prompt) {
                const apiKey = localStorage.getItem("geminiApiKey");
                if (!apiKey) {
                    throw new Error("Chave da API não encontrada. Por favor, insira sua chave nas configurações.");
                }
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const requestBody = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Detalhes do erro da API:", errorData);
                    throw new Error(`${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts[0]) {
                    return data.candidates[0].content.parts[0].text;
                }
                
                if (data.candidates && data.candidates[0].finishReason && data.candidates[0].finishReason !== 'STOP') {
                     throw new Error(`A geração de conteúdo foi interrompida por: ${data.candidates[0].finishReason}`);
                }

                throw new Error("Resposta da API em formato inesperado ou vazia.");
            },
            
            displayAnalysis(markdown, userAnswer) {
                this.state.lastAnalysis = {
                    question: this.state.currentQuestion,
                    userAnswer: userAnswer,
                    analysisMarkdown: markdown
                };
                const converter = new showdown.Converter({ tables: true, strikethrough: true, literalMidWordUnderscores: true });
                this.ui.analysisResult.innerHTML = converter.makeHtml(markdown);
                this.ui.loader.classList.add('hidden');
                this.ui.analysisResult.classList.remove('hidden');
                this.ui.analysisControls.classList.remove('hidden');
            },

            async downloadReport(button) {
                if (!this.state.lastAnalysis) {
                    alert("Nenhum relatório para baixar.");
                    return;
                }
                const originalText = button.textContent;
                button.textContent = "Gerando...";
                button.disabled = true;

                const { question, userAnswer, analysisMarkdown } = this.state.lastAnalysis;
                const converter = new showdown.Converter({ tables: true, strikethrough: true });
                const analysisHtml = converter.makeHtml(analysisMarkdown);
                const reportContainer = document.getElementById('reportContainer');
                
                reportContainer.innerHTML = `
                    <div class="header"><h1>Relatório de Desempenho - SEFAZ/SE</h1></div>
                    <div class="card"><h2>Questão Proposta</h2><p><strong>Tópico:</strong> ${question.topic}</p><p>${question.text}</p></div>
                    <div class="card"><h2>Sua Resposta</h2><pre>${userAnswer.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre></div>
                    <div class="card"><h2>Análise do Examinador</h2>${analysisHtml}</div>
                `;

                try {
                    const canvas = await html2canvas(reportContainer, { scale: 2, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`relatorio_discursiva_sefaz-se_${new Date().toISOString().slice(0, 10)}.pdf`);
                } catch (error) {
                    console.error("Erro ao gerar o PDF:", error);
                    alert("Ocorreu um erro ao gerar o PDF. Tente novamente.");
                } finally {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            },

            toggleModal(show) {
                if (show) {
                    this.ui.settingsModal.classList.remove('hidden');
                } else {
                    this.ui.settingsModal.classList.add('hidden');
                }
            },

            saveApiKey() {
                const apiKey = this.ui.apiKeyInput.value.trim();
                if (apiKey) {
                    localStorage.setItem("geminiApiKey", apiKey);
                    alert("Chave da API salva com sucesso!");
                    this.toggleModal(false);
                } else {
                    alert("Por favor, insira uma chave válida.");
                }
            },

            loadApiKey() {
                const apiKey = localStorage.getItem("geminiApiKey");
                if (apiKey) {
                    this.ui.apiKeyInput.value = apiKey;
                }
            },

            clearApiKey() {
                localStorage.removeItem("geminiApiKey");
                this.ui.apiKeyInput.value = "";
                alert("Chave da API removida.");
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
