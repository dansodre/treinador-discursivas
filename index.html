<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treinador de Discursivas - SEFAZ/SE 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <!-- Bibliotecas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .prose-custom p { margin-bottom: 1em; }
        .prose-custom h3 { margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose-custom ul { list-style-position: inside; padding-left: 1em; }
        .prose-custom li { margin-bottom: 0.5em; }
        #analysisResult blockquote {
            border-left: 4px solid #e5e7eb; padding-left: 1rem;
            margin-left: 0; font-style: italic; color: #4b5563;
        }
        .mode-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .modal-overlay { transition: opacity 0.3s ease; }

        /* Estilo para o relatório de impressão */
        .printable-report {
            position: absolute; left: -9999px; width: 800px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; background-color: #fff;
        }
        .printable-report .header { background-color: #343a40; color: white; padding: 20px; text-align: center; }
        .printable-report .card { padding: 25px; border-bottom: 1px solid #dee2e6; }
        .printable-report h1, .printable-report h2, .printable-report h3 { color: #343a40; }
        .printable-report h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; }
        .printable-report blockquote { border-left: 5px solid #007bff; margin: 1em 0; padding: 1em; background-color: #f1f3f5; }
        .printable-report pre { background-color: #e9ecef; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; }
        .printable-report table { border-collapse: collapse; width: 100%; margin-top: 1em; }
        .printable-report th, .printable-report td { border: 1px solid #ced4da; padding: 12px; text-align: left; }
        .printable-report th { background-color: #e9ecef; font-weight: 600; }

        /* Estilos Flashcard */
        .flashcard-container { perspective: 1000px; }
        .flashcard {
            width: 100%; height: 250px; position: relative;
            transform-style: preserve-3d; transition: transform 0.6s;
        }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
            border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .flashcard-front { background-color: #f3f4f6; border: 1px solid #d1d5db; }
        .flashcard-back {
            background-color: #e0f2fe; color: #0c4a6e;
            transform: rotateY(180deg);
            border: 1px solid #bae6fd;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl relative">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Treinador de Discursivas</h1>
            <p class="text-md text-gray-600 mt-2">Auditor Fiscal de Tributos Estaduais - SEFAZ/SE 2025</p>
        </header>

        <main id="app" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg min-h-[500px] flex flex-col">

            <!-- Telas de Seleção -->
            <div id="modeSelection">
                <h2 class="text-2xl font-semibold mb-6 text-center text-gray-800">Escolha seu modo de treino</h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                    <button data-mode="focado" class="mode-card bg-blue-50 p-6 rounded-xl border border-blue-200"><h3 class="font-bold text-lg text-blue-800">Questão Focada</h3><p class="text-sm text-blue-700 mt-2">Treine um tópico específico.</p></button>
                    <button data-mode="interdisciplinar" class="mode-card bg-purple-50 p-6 rounded-xl border border-purple-200"><h3 class="font-bold text-lg text-purple-800">Questão Interdisciplinar</h3><p class="text-sm text-purple-700 mt-2">Combine as matérias.</p></button>
                    <button data-mode="classico" class="mode-card bg-gray-50 p-6 rounded-xl border border-gray-200"><h3 class="font-bold text-lg text-gray-800">Questão por Nível</h3><p class="text-sm text-gray-700 mt-2">Pratique por dificuldade.</p></button>
                    <button data-mode="flashcards" class="mode-card bg-green-50 p-6 rounded-xl border border-green-200"><h3 class="font-bold text-lg text-green-800">Flashcards</h3><p class="text-sm text-green-700 mt-2">Memorize os conceitos.</p></button>
                </div>
            </div>

            <div id="subjectSelection" class="hidden">
                 <h2 class="text-xl font-semibold mb-4 text-center">Selecione a Matéria</h2>
                 <div id="subjectGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                 <button class="back-button mt-6 bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button>
            </div>
            
            <div id="topicSelection" class="hidden flex-grow flex flex-col">
                <h2 id="topicSelectionHeader" class="text-xl font-semibold mb-4 text-center">Selecione o(s) Tópico(s)</h2>
                <div id="topicCheckboxes" class="space-y-3 custom-scrollbar overflow-y-auto max-h-[350px] p-2 border rounded-lg"></div>
                <div class="mt-4 flex gap-4">
                    <button id="generateFocusedQuestion" class="w-full bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 disabled:bg-blue-300" disabled>Gerar Questão</button>
                    <button class="back-button w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button>
                </div>
            </div>

            <div id="interdisciplinarySelection" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">Combine as Matérias</h2>
                <p class="text-center text-sm text-gray-500 mb-4">Selecione as duas matérias para gerar uma questão.</p>
                <div id="interdisciplinaryCheckboxes" class="space-y-3"></div>
                <div class="mt-6 flex gap-4"><button id="generateInterdisciplinaryQuestion" class="w-full bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-700 disabled:bg-purple-300" disabled>Gerar Questão</button><button class="back-button w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button></div>
            </div>

            <div id="levelSelection" class="hidden flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-center">Selecione o Nível</h2>
                <div id="levelGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
                 <div id="subjectFilterForLevel" class="hidden mt-6 space-y-4">
                     <h3 class="text-lg font-semibold text-center text-gray-700">Filtre por Matéria (Opcional)</h3>
                     <select id="subjectFilterSelect" class="w-full p-2 border border-gray-300 rounded-lg"></select>
                     <div class="flex gap-4">
                         <button id="generateLevelQuestion" class="w-full bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-700">Gerar Questão</button>
                         <button class="back-to-levels-button w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar</button>
                     </div>
                 </div>
                <button class="back-button mt-6 bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 self-start">Voltar</button>
            </div>
            
            <!-- Tela de Flashcards -->
            <div id="flashcardScreen" class="hidden flex-grow flex flex-col">
                <div class="mb-4 flex flex-col sm:flex-row gap-4 items-center">
                    <label for="flashcardSubjectSelect" class="font-semibold text-gray-700">Matéria:</label>
                    <select id="flashcardSubjectSelect" class="flex-grow p-2 border border-gray-300 rounded-lg"></select>
                </div>
                <div id="flashcardContainer" class="flashcard-container flex-grow flex items-center justify-center">
                    <div id="flashcard" class="flashcard">
                        <div id="flashcardFront" class="flashcard-face flashcard-front text-2xl font-bold"></div>
                        <div id="flashcardBack" class="flashcard-face flashcard-back text-lg"></div>
                    </div>
                </div>
                 <div class="mt-6 flex flex-col sm:flex-row gap-3">
                    <button id="flipCardButton" class="w-full sm:w-auto bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 flex-grow">Virar Card</button>
                    <button id="nextCardButton" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Próximo Conceito</button>
                    <button class="back-button w-full sm:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar ao Menu</button>
                </div>
            </div>

            <!-- Tela da Questão -->
            <div id="questionScreen" class="hidden">
                <div class="mb-6"><div class="flex justify-between items-center mb-2"><span id="questionTopic" class="text-xs font-semibold uppercase text-blue-600 bg-blue-100 px-3 py-1 rounded-full"></span><span id="questionLevel" class="text-xs font-semibold uppercase text-gray-500"></span></div><h3 class="text-lg font-semibold leading-relaxed" id="questionText"></h3></div>
                <div><label for="userAnswer" class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta (até 20 linhas):</label><textarea id="userAnswer" rows="12" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea><div class="flex justify-between items-center mt-1"><span id="lineCount" class="text-sm text-gray-500">0 linhas</span><span id="charCount" class="text-sm text-gray-500">0 caracteres</span></div></div>
                <div class="mt-6 flex flex-col sm:flex-row gap-3"><button id="submitAnswer" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex-grow">Analisar</button><button id="backToMain" class="w-full sm:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar ao Início</button></div>
            </div>
            
            <!-- Tela de Análise -->
            <div id="analysisScreen" class="hidden">
                <div id="loader" class="text-center py-10"><svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-4 text-lg font-semibold text-gray-700">Analisando sua resposta...</p></div>
                <div id="analysisResult" class="hidden prose-custom max-w-none"></div>
                <div id="analysisControls" class="hidden mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row gap-3"><button id="nextQuestion" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 flex-grow">Próxima Questão</button><button id="downloadReport" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Baixar Relatório (PDF)</button><button id="backToMainFromAnalysis" class="w-full sm:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Voltar ao Início</button></div>
            </div>
        </main>
    </div>

    <!-- Div para gerar PDF -->
    <div id="reportContainer" class="printable-report"></div>

    <script>
        const { jsPDF } = window.jspdf;
        // --- BANCO DE DADOS DE CONTEÚDO DO EDITAL - SEFAZ/SE 2025 ---
        const subjectDetailsDB = {
            'Legislação Tributária Estadual': {
                name: 'Legislação Tributária Estadual',
                topics: [
                    'ICMS (Lei 3.796/96 e Dec. 21.400/02)',
                    'Processo Administrativo Fiscal (Lei 7.651/13)',
                    'PSDI (Lei 3.140/91)',
                    'FEEF (Lei 8.180/16)',
                    'IPVA (Lei 7.655/13)',
                    'ITCMD (Lei 7.724/13)',
                    'Taxa Estadual (TFSD - Lei 8.638/19)',
                    'Fundo de Combate à Pobreza (Lei 4.731/02)'
                ],
                questions: [
                    { level: 7, topic: 'ICMS (Lei 3.796/96 e Dec. 21.400/02)', subjects: ['Legislação Tributária Estadual'], text: 'Discorra sobre o instituto da substituição tributária "para frente" do ICMS, previsto na legislação de Sergipe. Aborde o conceito, a responsabilidade pelo recolhimento do imposto e a forma de cálculo da base de cálculo presumida.' },
                    { level: 8, topic: 'Processo Administrativo Fiscal (Lei 7.651/13)', subjects: ['Legislação Tributária Estadual'], text: 'Analise as fases do Processo Administrativo Fiscal em Sergipe, desde a lavratura do auto de infração até a decisão final em segunda instância. Destaque os principais direitos e garantias do contribuinte nesse processo.' },
                ],
                flashcards: [
                    { term: "Fato Gerador do ICMS", definition: "Regra geral, é a saída de mercadoria de estabelecimento de contribuinte. Outras hipóteses incluem fornecimento de alimentação, transporte, importação, etc. (Lei 3.796/96)" },
                    { term: "Base de Cálculo do ICMS", definition: "Normalmente, é o valor da operação de que decorrer a saída da mercadoria. Inclui frete e outras despesas debitadas ao adquirente." },
                    { term: "Contribuinte do ICMS", definition: "Qualquer pessoa, física ou jurídica, que realize, com habitualidade ou em volume que caracterize intuito comercial, operações de circulação de mercadoria ou prestações de serviços de transporte e comunicação." },
                    { term: "Não Cumulatividade (ICMS)", definition: "Princípio que permite ao contribuinte abater do imposto devido em suas operações o montante cobrado nas operações anteriores (crédito do imposto)." },
                    { term: "Substituição Tributária (ICMS)", definition: "Regime no qual a responsabilidade pelo recolhimento do imposto de operações futuras é atribuída a um contribuinte anterior na cadeia (ex: indústria recolhe pelo varejo)." },
                    { term: "Contencioso Administrativo Fiscal", definition: "Órgão julgador de primeira instância no PAF de Sergipe, responsável por julgar as impugnações aos autos de infração. (Lei 7.651/2013)" },
                    { term: "Conselho de Contribuintes", definition: "Órgão julgador de segunda e última instância administrativa no PAF de Sergipe, com composição paritária entre representantes do Fisco e dos contribuintes." },
                    { term: "Fato Gerador do IPVA", definition: "A propriedade de veículo automotor. Ocorre no primeiro dia de janeiro de cada exercício. (Lei 7.655/2013)" },
                    { term: "Fato Gerador do ITCMD", definition: "A transmissão 'causa mortis' (herança) ou por doação de quaisquer bens ou direitos. (Lei 7.724/2013)" },
                    { term: "Fundo de Combate à Pobreza (FCP)", definition: "Financiado por um adicional na alíquota do ICMS sobre produtos e serviços considerados supérfluos, como bebidas alcoólicas, cigarros e cosméticos. (Lei 4.731/02)" },
                    { term: "PSDI", definition: "Programa Sergipano de Desenvolvimento Industrial, que concede incentivos fiscais (crédito presumido de ICMS) para empresas que se instalem ou expandam suas atividades no estado. (Lei 3.140/1991)" }
                ]
            },
            'Auditoria Fiscal': {
                name: 'Auditoria Fiscal',
                topics: [
                    'Normas de Auditoria (NBC TA e PA)',
                    'Amostragem em Auditoria (NBC TA 530)',
                    'Testes de observância e substantivos',
                    'Evidências e procedimentos de auditoria',
                    'Fraudes na escrita contábil',
                    'Auditoria do Ativo Circulante (Caixa, Estoques)',
                    'Auditoria do Ativo Não Circulante',
                    'Auditoria do Passivo e PL',
                    'Auditoria de Contas de Resultado',
                    'Fraudes na escrita fiscal (EFD, NFe)',
                    'Auditoria no CIAP',
                    'Sigilo Bancário (LC 105/2001)'
                ],
                questions: [
                    { level: 9, topic: 'Fraudes na escrita fiscal (EFD, NFe)', subjects: ['Auditoria Fiscal'], text: 'Descreva os procedimentos de auditoria fiscal aplicáveis para identificar a omissão de receitas por meio da análise cruzada de dados da Escrituração Fiscal Digital (EFD) e das Notas Fiscais Eletrônicas (NFe) de entrada e saída. Cite ao menos três possíveis inconsistências a serem investigadas.' },
                    { level: 10, topic: 'Auditoria e Legislação', subjects: ['Auditoria Fiscal', 'Legislação Tributária Estadual'], text: 'Considerando as normas de auditoria fiscal (NBC TA) e a legislação do ICMS de Sergipe, descreva os procedimentos de auditoria que você aplicaria para identificar a falta de recolhimento do imposto decorrente de suprimentos de caixa não comprovados (passivo fictício) em uma empresa comercial. Relacione os achados da auditoria com as possíveis penalidades previstas na lei do Processo Administrativo Fiscal do estado.' }
                ],
                flashcards: [
                    { term: "Risco de Auditoria", definition: "É o risco de o auditor expressar uma opinião de auditoria inadequada quando as demonstrações contábeis contiverem distorção relevante. Componentes: Risco Inerente, de Controle e de Detecção." },
                    { term: "Evidência de Auditoria", definition: "Informações utilizadas pelo auditor para fundamentar suas conclusões. Deve ser apropriada (relevante e confiável) e suficiente (quantidade)." },
                    { term: "Testes de Observância (ou de Controles)", definition: "Procedimentos de auditoria para testar a efetividade operacional dos controles internos na prevenção ou detecção e correção de distorções relevantes." },
                    { term: "Testes Substantivos", definition: "Procedimentos de auditoria para detectar distorções relevantes no nível de afirmações. Incluem testes de detalhes (de saldos e transações) e procedimentos analíticos substantivos." },
                    { term: "Amostragem em Auditoria (NBC TA 530)", definition: "Aplicação de procedimentos de auditoria em menos de 100% dos itens de uma população, de forma que todas as unidades de amostragem tenham a mesma chance de serem selecionadas." },
                    { term: "Circularização (Confirmação Externa)", definition: "Procedimento de auditoria que consiste em obter evidência diretamente de terceiros, como confirmação de saldos de contas a receber com clientes ou saldos bancários com bancos." },
                    { term: "Passivo Fictício", definition: "Registro de uma obrigação inexistente no passivo da empresa, geralmente com o objetivo de justificar uma entrada de recursos (suprimento de caixa) de origem ilícita ou não declarada." },
                    { term: "Ativo Oculto", definition: "Bens ou direitos da empresa não registrados em sua contabilidade, frequentemente adquiridos com recursos de receitas não declaradas ('caixa dois')." },
                    { term: "EFD ICMS/IPI", definition: "Escrituração Fiscal Digital. Arquivo digital que substitui os livros de registro de entradas, saídas, inventário e apuração do ICMS e IPI." },
                    { term: "Cruzamento de Dados Fiscais", definition: "Técnica de auditoria que consiste em comparar informações de diferentes fontes (ex: EFD, NFe, ECF, Decred) para identificar inconsistências que apontem para sonegação fiscal." },
                    { term: "Quebra de Sigilo Bancário (LC 105/2001)", definition: "A autoridade fiscal pode requisitar informações sobre movimentações financeiras de contribuintes diretamente às instituições financeiras, em caso de processo administrativo fiscal instaurado." },
                    { term: "CIAP", definition: "Controle de Crédito de ICMS do Ativo Permanente. Documento fiscal para controlar o crédito de ICMS sobre a aquisição de bens destinados ao ativo imobilizado, que deve ser apropriado na razão de 1/48 por mês." }
                ]
            }
        };

        const app = {
            ui: {
                modeSelection: document.getElementById('modeSelection'),
                subjectSelection: document.getElementById('subjectSelection'),
                topicSelection: document.getElementById('topicSelection'),
                interdisciplinarySelection: document.getElementById('interdisciplinarySelection'),
                levelSelection: document.getElementById('levelSelection'),
                flashcardScreen: document.getElementById('flashcardScreen'),
                questionScreen: document.getElementById('questionScreen'),
                analysisScreen: document.getElementById('analysisScreen'),
                loader: document.getElementById('loader'),
                analysisResult: document.getElementById('analysisResult'),
                analysisControls: document.getElementById('analysisControls'),
                questionTopic: document.getElementById('questionTopic'),
                questionLevel: document.getElementById('questionLevel'),
                questionText: document.getElementById('questionText'),
                userAnswer: document.getElementById('userAnswer'),
                lineCount: document.getElementById('lineCount'),
                charCount: document.getElementById('charCount'),
                subjectGrid: document.getElementById('subjectGrid'),
                topicCheckboxes: document.getElementById('topicCheckboxes'),
                topicSelectionHeader: document.getElementById('topicSelectionHeader'),
                generateFocusedQuestionBtn: document.getElementById('generateFocusedQuestion'),
                interdisciplinaryCheckboxes: document.getElementById('interdisciplinaryCheckboxes'),
                levelGrid: document.getElementById('levelGrid'),
                generateInterdisciplinaryBtn: document.getElementById('generateInterdisciplinaryQuestion'),
                subjectFilterForLevel: document.getElementById('subjectFilterForLevel'),
                subjectFilterSelect: document.getElementById('subjectFilterSelect'),
                generateLevelQuestionBtn: document.getElementById('generateLevelQuestion'),
                // Flashcard UI
                flashcardSubjectSelect: document.getElementById('flashcardSubjectSelect'),
                flashcard: document.getElementById('flashcard'),
                flashcardFront: document.getElementById('flashcardFront'),
                flashcardBack: document.getElementById('flashcardBack'),
                flipCardButton: document.getElementById('flipCardButton'),
                nextCardButton: document.getElementById('nextCardButton'),
            },
            
            state: {
                currentMode: null, currentSubject: null, currentFilters: {},
                currentQuestion: null, lastQuestionIndex: -1, lastAnalysis: null,
                flashcardDeck: [], currentFlashcardIndex: 0,
            },

            init() {
                this.setupEventListeners();
                this.renderSelections();
                this.showScreen('modeSelection');
            },
            
            setupEventListeners() {
                this.ui.modeSelection.addEventListener('click', e => this.handleModeSelection(e));
                document.querySelectorAll('.back-button').forEach(btn => btn.addEventListener('click', () => this.goBack()));
                this.ui.subjectGrid.addEventListener('click', e => this.handleSubjectSelection(e));
                this.ui.levelGrid.addEventListener('click', e => this.handleLevelSelection(e));
                
                this.ui.topicCheckboxes.addEventListener('change', () => this.updateFocusedButtonState());
                this.ui.generateFocusedQuestionBtn.addEventListener('click', () => this.startFocusedMode());

                this.ui.interdisciplinaryCheckboxes.addEventListener('change', () => this.updateInterdisciplinaryButtonState());
                this.ui.generateInterdisciplinaryBtn.addEventListener('click', () => this.startInterdisciplinaryMode());
                
                this.ui.generateLevelQuestionBtn.addEventListener('click', () => this.startClassicMode());
                document.querySelector('.back-to-levels-button').addEventListener('click', () => this.goBackToLevelGrid());

                document.getElementById('submitAnswer').addEventListener('click', () => this.submitAnswer());
                document.getElementById('backToMain').addEventListener('click', () => this.showScreen('modeSelection'));
                document.getElementById('nextQuestion').addEventListener('click', () => this.loadQuestion());
                document.getElementById('backToMainFromAnalysis').addEventListener('click', () => this.showScreen('modeSelection'));
                document.getElementById('downloadReport').addEventListener('click', (e) => this.downloadReport(e.target));
                this.ui.userAnswer.addEventListener('input', () => this.updateCounts());
                
                // Flashcard Listeners
                this.ui.flashcardSubjectSelect.addEventListener('change', (e) => this.loadFlashcardDeck(e.target.value));
                this.ui.flipCardButton.addEventListener('click', () => this.flipCard());
                this.ui.nextCardButton.addEventListener('click', () => this.nextCard());

            },
            
            renderSelections() {
                const subjectKeys = Object.keys(subjectDetailsDB);
                this.ui.subjectGrid.innerHTML = subjectKeys.map(key => `<button data-subject="${key}" class="w-full text-md font-semibold p-4 border rounded-lg transition hover:bg-blue-500 hover:text-white hover:border-blue-500">${subjectDetailsDB[key].name}</button>`).join('');
                this.ui.interdisciplinaryCheckboxes.innerHTML = subjectKeys.map(key => `<label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="subject" value="${key}" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"><span class="ml-3 text-gray-700">${subjectDetailsDB[key].name}</span></label>`).join('');
                this.ui.flashcardSubjectSelect.innerHTML = subjectKeys.map(key => `<option value="${key}">${subjectDetailsDB[key].name}</option>`).join('');
                
                let subjectOptions = `<option value="all">Todas as Matérias</option>`;
                subjectOptions += subjectKeys.map(key => `<option value="${key}">${subjectDetailsDB[key].name}</option>`).join('');
                this.ui.subjectFilterSelect.innerHTML = subjectOptions;

                const levels = Array.from({ length: 10 }, (_, i) => i + 1);
                this.ui.levelGrid.innerHTML = levels.map(level => `<button data-level="${level}" class="w-full text-lg font-semibold p-4 border rounded-lg transition hover:bg-gray-500 hover:text-white hover:border-gray-500">Nível ${level}</button>`).join('');
            },

            handleModeSelection(e) {
                const button = e.target.closest('button');
                if (!button || !button.dataset.mode) return;
                this.state.currentMode = button.dataset.mode;
                if (this.state.currentMode === 'focado') this.showScreen('subjectSelection');
                else if (this.state.currentMode === 'interdisciplinar') this.showScreen('interdisciplinarySelection');
                else if (this.state.currentMode === 'classico') this.showScreen('levelSelection');
                else if (this.state.currentMode === 'flashcards') this.startFlashcardMode();
            },

            startFlashcardMode() {
                this.showScreen('flashcardScreen');
                this.loadFlashcardDeck(this.ui.flashcardSubjectSelect.value);
            },

            loadFlashcardDeck(subjectKey) {
                const deck = subjectDetailsDB[subjectKey]?.flashcards || [];
                this.state.flashcardDeck = deck
                    .map(value => ({ value, sort: Math.random() }))
                    .sort((a, b) => a.sort - b.sort)
                    .map(({ value }) => value);
                this.state.currentFlashcardIndex = 0;
                this.displayCurrentCard();
            },

            displayCurrentCard() {
                if(this.ui.flashcard.classList.contains('is-flipped')) {
                    this.ui.flashcard.classList.remove('is-flipped');
                }
                setTimeout(() => {
                    const card = this.state.flashcardDeck[this.state.currentFlashcardIndex];
                    if (card) {
                        this.ui.flashcardFront.textContent = card.term;
                        this.ui.flashcardBack.textContent = card.definition;
                    } else {
                        this.ui.flashcardFront.textContent = 'Sem cards!';
                        this.ui.flashcardBack.textContent = 'Não há conceitos para esta matéria no momento.';
                    }
                }, 300); 
            },

            flipCard() { this.ui.flashcard.classList.toggle('is-flipped'); },

            nextCard() {
                this.state.currentFlashcardIndex++;
                if (this.state.currentFlashcardIndex >= this.state.flashcardDeck.length) {
                    if (this.ui.flashcard.classList.contains('is-flipped')) {
                        this.ui.flashcard.classList.remove('is-flipped');
                    }
                     setTimeout(() => {
                        this.ui.flashcardFront.textContent = 'Fim do Ciclo!';
                        this.ui.flashcardBack.textContent = 'Embaralhando o baralho novamente...';
                        setTimeout(() => this.loadFlashcardDeck(this.ui.flashcardSubjectSelect.value), 1500);
                    }, 300);
                } else {
                    this.displayCurrentCard();
                }
            },
            
            handleSubjectSelection(e){const t=e.target.closest("button");t&&t.dataset.subject&&(this.state.currentSubject=t.dataset.subject,this.renderTopics(this.state.currentSubject),this.showScreen("topicSelection"))},
            
            handleLevelSelection(e) {
                const button = e.target.closest('button');
                if (!button || !button.dataset.level) return;
                this.state.currentFilters = { level: parseInt(button.dataset.level) };
                this.ui.levelGrid.classList.add('hidden');
                this.ui.levelSelection.querySelector('.back-button').classList.add('hidden');
                this.ui.subjectFilterForLevel.classList.remove('hidden');
            },

            goBackToLevelGrid() {
                 this.ui.subjectFilterForLevel.classList.add('hidden');
                 this.ui.levelGrid.classList.remove('hidden');
                 this.ui.levelSelection.querySelector('.back-button').classList.remove('hidden');
                 this.state.currentFilters = {};
            },

            renderTopics(e){const t=subjectDetailsDB[e];this.ui.topicSelectionHeader.textContent=`Tópicos de ${t.name}`,this.ui.topicCheckboxes.innerHTML=t.topics.map(e=>`<label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">\n                         <input type="checkbox" name="topic" value="${e}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">\n                         <span class="ml-3 text-gray-700">${e}</span>\n                     </label>`).join(""),this.updateFocusedButtonState()},goBack(){"focado"===this.state.currentMode&&this.state.currentSubject?(this.state.currentSubject=null,this.showScreen("subjectSelection")):(this.state.currentMode=null,this.showScreen("modeSelection"))},startFocusedMode(){const e=Array.from(this.ui.topicCheckboxes.querySelectorAll("input:checked")).map(e=>e.value);this.state.currentFilters={subject:this.state.currentSubject,topics:e},this.loadQuestion()},
            
            startClassicMode() {
                const subject = this.ui.subjectFilterSelect.value;
                if (subject && subject !== 'all') {
                    this.state.currentFilters.subject = subject;
                } else {
                    delete this.state.currentFilters.subject;
                }
                this.loadQuestion();
            },

            updateFocusedButtonState(){this.ui.generateFocusedQuestionBtn.disabled=this.ui.topicCheckboxes.querySelectorAll("input:checked").length<1},startInterdisciplinaryMode(){const e=Array.from(this.ui.interdisciplinaryCheckboxes.querySelectorAll("input:checked")).map(e=>e.value);this.state.currentFilters={subjects:e,interdisciplinary:!0},this.loadQuestion()},updateInterdisciplinaryButtonState(){this.ui.generateInterdisciplinaryBtn.disabled=this.ui.interdisciplinaryCheckboxes.querySelectorAll("input:checked").length<2},
            
            getFilteredQuestions() {
                const { level, subject, subjects, topics, interdisciplinary } = this.state.currentFilters;
                let allQuestions = Object.values(subjectDetailsDB).flatMap(s => s.questions);

                if (interdisciplinary) {
                    return allQuestions.filter(q => 
                        subjects && subjects.length > 1 && subjects.every(sub => q.subjects.includes(sub))
                    );
                }

                return allQuestions.filter(q => {
                    const levelMatch = !level || q.level === level;
                    const subjectMatch = !subject || q.subjects.includes(subject);
                    const topicMatch = !topics || !topics.length || topics.some(t => q.topic.includes(t));
                    return levelMatch && subjectMatch && topicMatch && q.subjects.length <= 1;
                });
            },
            
            async loadQuestion() {
                const displayQuestion = () => {
                    if (!this.state.currentQuestion) return;
                    this.ui.questionTopic.textContent = this.state.currentQuestion.topic;
                    this.ui.questionLevel.textContent = `Nível ${this.state.currentQuestion.level}`;
                    this.ui.questionText.textContent = this.state.currentQuestion.text;
                    this.ui.userAnswer.value = "";
                    this.updateCounts();
                    this.showScreen('questionScreen');
                };

                let filteredQuestions = this.getFilteredQuestions();
                
                if (filteredQuestions.length > 0) {
                    let newIndex;
                    do {
                        newIndex = Math.floor(Math.random() * filteredQuestions.length);
                    } while (filteredQuestions.length > 1 && newIndex === this.state.lastQuestionIndex);
                    this.state.lastQuestionIndex = newIndex;
                    this.state.currentQuestion = filteredQuestions[newIndex];
                    displayQuestion();
                } else {
                    this.showScreen("loader"); 
                    try {
                        const newQuestionText = await this.generateNewQuestion();
                        this.state.currentQuestion = {
                            level: this.state.currentFilters.level || 8,
                            subjects: this.state.currentFilters.subjects || [this.state.currentSubject],
                            topic: this.state.currentFilters.topics ? this.state.currentFilters.topics.join(' + ') : 'Geral (Interdisciplinar)',
                            text: newQuestionText
                        };
                        displayQuestion();
                    } catch (error) {
                        console.error("Erro ao gerar questão:", error);
                        alert(`Não foi possível gerar uma nova questão. Detalhes: ${error.message}`);
                        this.goBack();
                    }
                }
            },

            async generateNewQuestion() {
                const { topics, subject, subjects, level } = this.state.currentFilters;
                let context = `Gere uma única questão discursiva inédita para o concurso de Auditor Fiscal da SEFAZ/SE, com complexidade de nível ${level || 'avançado'}. A questão deve ser complexa, exigir raciocínio e ser estritamente aderente ao conteúdo do edital. `;
                if (topics && subject) {
                    context += `Foque no(s) tópico(s) "${topics.join(', ')}" da matéria "${subjectDetailsDB[subject].name}".`;
                } else if (subjects) {
                    context += `A questão deve ser interdisciplinar, conectando as matérias: ${subjects.map(s => subjectDetailsDB[s].name).join(' e ')}.`;
                }
                const prompt = `Você é um elaborador de questões de concurso da banca Cebraspe. Sua tarefa é criar uma questão discursiva. Responda APENAS com o texto da questão, sem nenhum texto adicional. ${context}`;
                return await this.callGeminiAPI(prompt);
            },

            updateCounts(){const e=this.ui.userAnswer.value,t=e.trim()?e.split("\n").length:0;this.ui.charCount.textContent=`${e.length} caracteres`,this.ui.lineCount.textContent=`${t} linha${1!==t?"s":""}`},showScreen(e){["modeSelection","subjectSelection","topicSelection","interdisciplinarySelection","levelSelection","questionScreen","analysisScreen","loader","flashcardScreen"].forEach(t=>this.ui[t]?.classList.add("hidden")),this.ui[e]&&this.ui[e].classList.remove("hidden"),"analysisScreen"!==e&&"loader"!==e||(this.ui.loader.classList.remove("hidden"),this.ui.analysisResult.classList.add("hidden"),this.ui.analysisControls.classList.add("hidden"))},
            
            async submitAnswer() {
                const userAnswer = this.ui.userAnswer.value.trim();
                if (userAnswer.length < 50) {
                    alert("Por favor, elabore um pouco mais sua resposta.");
                    return;
                }
                this.showScreen("analysisScreen");
                try {
                    const prompt = `Você é um examinador experiente da banca Cebraspe, corrigindo uma prova para o cargo de Auditor Fiscal de Tributos Estaduais da SEFAZ/SE. Sua tarefa é analisar uma resposta discursiva de um candidato de forma crítica e construtiva. A sua resposta DEVE ser em Markdown e seguir ESTRITAMENTE a estrutura abaixo:
### Análise da Resposta
Faça uma análise geral da resposta do candidato, abordando o conhecimento técnico demonstrado.
### Atribuição de Nota (Simulada)
Apresente uma tabela em Markdown com a nota (máximo 40 pontos), dividida entre "Domínio do Conteúdo" (30) e "Domínio da Modalidade Escrita" (10), com justificativas claras e objetivas, conforme o edital.
| Critério | Pontuação Máxima | Nota Atribuída | Justificativa |
| :--- | :--- | :--- | :--- |
| **A. Domínio do Conteúdo** | **30** | ... | ... |
| **B. Domínio da Modalidade Escrita** | **10** | ... | ... |
| **NOTA FINAL** | **40** | **...** | |
### Ponderações e Pontos a Melhorar
Crie duas listas: **Pontos Fortes** e **Pontos a Melhorar**, com sugestões práticas e específicas para o concurso.
### Versão Aprimorada da Resposta
Reescreva a resposta de forma ideal, como um gabarito nota máxima, com linguagem técnica e precisa. Envolva o texto em um bloco de citação (blockquote).
---
**Questão Proposta:** "${this.state.currentQuestion.text}"
**Resposta do Candidato:** "${userAnswer}"`;
                    const analysis = await this.callGeminiAPI(prompt);
                    this.displayAnalysis(analysis, userAnswer);
                } catch (error) {
                    console.error(error);
                    this.displayAnalysis(`# Erro na Análise\n\nOcorreu um problema ao contatar o examinador virtual. Detalhes: ${error.message}`, userAnswer);
                }
            },

            async callGeminiAPI(prompt) {
                // A chave da API é fornecida pelo ambiente de execução, não mais pelo usuário.
                const apiKey = ""; 
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const requestBody = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Detalhes do erro da API:", errorData);
                    throw new Error(`${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts[0]) {
                    return data.candidates[0].content.parts[0].text;
                }
                
                if (data.candidates && data.candidates[0].finishReason && data.candidates[0].finishReason !== 'STOP') {
                     throw new Error(`A geração de conteúdo foi interrompida por: ${data.candidates[0].finishReason}`);
                }

                throw new Error("Resposta da API em formato inesperado ou vazia.");
            },
            
            displayAnalysis(markdown, userAnswer) {
                this.state.lastAnalysis = {
                    question: this.state.currentQuestion,
                    userAnswer: userAnswer,
                    analysisMarkdown: markdown
                };
                const converter = new showdown.Converter({ tables: true, strikethrough: true, literalMidWordUnderscores: true });
                this.ui.analysisResult.innerHTML = converter.makeHtml(markdown);
                this.ui.loader.classList.add('hidden');
                this.ui.analysisResult.classList.remove('hidden');
                this.ui.analysisControls.classList.remove('hidden');
            },

            async downloadReport(button) {
                if (!this.state.lastAnalysis) {
                    alert("Nenhum relatório para baixar.");
                    return;
                }
                const originalText = button.textContent;
                button.textContent = "Gerando...";
                button.disabled = true;

                const { question, userAnswer, analysisMarkdown } = this.state.lastAnalysis;
                const converter = new showdown.Converter({ tables: true, strikethrough: true });
                const analysisHtml = converter.makeHtml(analysisMarkdown);
                const reportContainer = document.getElementById('reportContainer');
                
                reportContainer.innerHTML = `
                    <div class="header"><h1>Relatório de Desempenho - SEFAZ/SE</h1></div>
                    <div class="card"><h2>Questão Proposta</h2><p><strong>Tópico:</strong> ${question.topic}</p><p>${question.text}</p></div>
                    <div class="card"><h2>Sua Resposta</h2><pre>${userAnswer.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre></div>
                    <div class="card"><h2>Análise do Examinador</h2>${analysisHtml}</div>
                `;

                try {
                    const canvas = await html2canvas(reportContainer, { scale: 2, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`relatorio_discursiva_sefaz-se_${new Date().toISOString().slice(0, 10)}.pdf`);
                } catch (error) {
                    console.error("Erro ao gerar o PDF:", error);
                    alert("Ocorreu um erro ao gerar o PDF. Tente novamente.");
                } finally {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
